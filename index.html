<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منظور | Manthoor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            padding: 20px;
            padding-top: 44px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Professional Background - Clean Gradient */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%),
                radial-gradient(ellipse at top left, rgba(30, 58, 138, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(30, 64, 175, 0.1) 0%, transparent 50%);
            background-size: 100% 100%, 800px 800px, 800px 800px;
            background-position: center, -200px -200px, calc(100% + 200px) calc(100% + 200px);
            z-index: 0;
            pointer-events: none;
        }
        
        body::after {
            display: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            display: flex;
            gap: 20px;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            min-width: 250px;
            background: linear-gradient(135deg, rgba(90, 90, 90, 0.25) 0%, rgba(107, 107, 107, 0.25) 30%, rgba(74, 74, 74, 0.25) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 20px;
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            z-index: 2;
        }

        /* Mobile bottom tab bar (hidden by default, shown in mobile media query) */
        .mobile-tab-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            padding-bottom: env(safe-area-inset-bottom, 0);
            display: none; /* enabled in mobile media query */
            justify-content: center;
            align-items: flex-end;
            z-index: 20;
            pointer-events: none; /* inner pill handles clicks */
        }
        
        .mobile-tab-pill {
            pointer-events: auto;
            width: 100%;
            max-width: 100%;
            margin: 8px 0 0 0;
            height: 58px;
            min-height: 58px;
            padding: 8px 24px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 0));
            border-radius: 0;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: linear-gradient(135deg, rgba(15, 27, 46, 0.98), rgba(24, 45, 73, 0.98));
            box-shadow: 
                0 -4px 20px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.08) inset;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 4px;
            box-sizing: border-box;
        }
        
        .mobile-tab-link {
            flex: 1;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.7rem;
            padding: 6px 4px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }
        
        .mobile-tab-link.active {
            color: rgba(255, 255, 255, 0.98);
            background: radial-gradient(circle at top left, rgba(70, 130, 180, 0.95), rgba(40, 80, 140, 0.95));
            box-shadow:
                0 8px 18px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(255, 255, 255, 0.25);
        }
        
        /* Goals mobile stacked cards + metric toggle */
        /* desktop-only container for goals table (hidden on mobile via media query) */
        .goals-desktop-table {
            display: block;
        }
        .goals-mobile-toggle {
            display: none;
            margin-top: 6px;
            margin-bottom: 10px;
            gap: 6px;
            justify-content: center;
        }
        
        .goals-toggle-btn {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(10, 20, 35, 0.9);
            color: rgba(255, 255, 255, 0.75);
            padding: 5px 10px;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .goals-toggle-btn.active {
            background: radial-gradient(circle at top left, rgba(70, 130, 180, 0.95), rgba(40, 80, 140, 0.95));
            color: rgba(255, 255, 255, 0.98);
            border-color: rgba(255, 255, 255, 0.45);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6);
        }
        
        .goals-mobile-cards {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
            padding-bottom: 60px;
        }
        
        .goal-mobile-card {
            border-radius: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .goal-mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .goal-mobile-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.98);
            letter-spacing: -0.01em;
        }
        
        .goal-mobile-chip {
            font-size: 0.6875rem;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .goal-mobile-bar-row {
            margin-top: 4px;
        }
        
        .goal-mobile-bar-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .goal-mobile-bar-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .goal-mobile-bar-percent {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .goal-mobile-bar-bg {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            overflow: hidden;
        }
        
        .goal-mobile-bar-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(70, 130, 180, 0.9), rgba(0, 200, 255, 0.95));
        }
        
        /* Mobile zone + PHC layout inspired by sketch */
        .goal-mobile-overall-track {
            width: 100%;
            height: 6px;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
            margin: 8px 0 12px;
            position: relative;
        }
        
        .goal-mobile-overall-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #4A90E2, #5BA3F5);
            transition: width 0.3s ease;
            box-shadow: 0 0 8px rgba(74, 144, 226, 0.4);
        }
        
        .goal-mobile-overall-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .goal-mobile-metrics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        
        .goal-mobile-circle-metric {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .goal-mobile-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background:
                conic-gradient(
                    #4A90E2 var(--pct, 0%),
                    rgba(255, 255, 255, 0.12) 0
                );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.2s ease;
        }
        
        .goal-mobile-circle:active {
            transform: scale(0.95);
        }
        
        .goal-mobile-circle-inner {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(10, 20, 35, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            color: #fff;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .goal-mobile-circle-label {
            color: rgba(255, 255, 255, 0.75);
            text-align: center;
            font-size: 0.625rem;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .goal-info-icon {
            cursor: help;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.65rem;
            font-weight: 600;
            transition: color 0.2s ease;
            user-select: none;
        }
        
        .goal-info-icon:hover {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Flip functionality for Screened circle */
        .goal-mobile-circle-flip {
            perspective: 1000px;
            cursor: pointer;
            width: 100%;
            height: 100%;
            min-height: 70px;
        }
        
        .goal-mobile-circle-flip-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 70px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .goal-mobile-circle-flip.flipped .goal-mobile-circle-flip-inner {
            transform: rotateY(180deg);
        }
        
        .goal-mobile-circle-flip-front,
        .goal-mobile-circle-flip-back {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 70px;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .goal-mobile-circle-flip-back {
            transform: rotateY(180deg);
        }
        
        .goal-mobile-circle-back-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-align: center;
            padding: 8px;
        }
        
        .goal-mobile-circle-back-label {
            font-size: 0.5625rem;
            color: rgba(255, 255, 255, 0.75);
            font-weight: 500;
        }
        
        .goal-mobile-circle-back-value {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.98);
            font-weight: 700;
            line-height: 1.2;
        }
        
        .goal-mobile-circle-back-goal {
            font-size: 0.5625rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* Smaller circles for PHC cards */
        .goal-mobile-phc-card .goal-mobile-circle {
            width: 40px;
            height: 40px;
        }
        
        .goal-mobile-phc-card .goal-mobile-circle-inner {
            width: 30px;
            height: 30px;
            font-size: 0.5625rem;
        }
        
        .goal-mobile-phc-card .goal-mobile-circle-label {
            font-size: 0.5625rem;
        }
        
        .goal-mobile-phc-card .goal-mobile-metrics-row {
            gap: 6px;
            margin-top: 0;
        }
        
        /* Horizontal swipe row of zone cards on mobile */
        .goals-mobile-zones-row {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px 0 8px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .goals-mobile-zones-row::-webkit-scrollbar {
            display: none;
        }
        
        .goal-mobile-zone-card {
            flex: 0 0 88%;
            scroll-snap-align: center;
        }
        
        .goal-mobile-phc-cards {
            margin-top: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Zone pagination dots */
        .goals-mobile-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 4px 0;
        }
        
        .goals-mobile-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .goals-mobile-dot.active {
            width: 20px;
            height: 6px;
            border-radius: 3px;
        }
        
        /* Progress-based colors */
        .goals-mobile-dot.progress-excellent {
            background: rgba(76, 175, 80, 0.6);
        }
        
        .goals-mobile-dot.progress-good {
            background: rgba(255, 193, 7, 0.6);
        }
        
        .goals-mobile-dot.progress-poor {
            background: rgba(244, 67, 54, 0.6);
        }
        
        .goals-mobile-dot.active.progress-excellent {
            background: rgba(76, 175, 80, 0.95);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        
        .goals-mobile-dot.active.progress-good {
            background: rgba(255, 193, 7, 0.95);
            box-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
        }
        
        .goals-mobile-dot.active.progress-poor {
            background: rgba(244, 67, 54, 0.95);
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
        }
        
        .goal-mobile-phc-cards.expanded {
            display: flex;
        }
        
        .goal-mobile-show-phcs {
            margin-top: 8px;
            padding: 8px;
            text-align: center;
            font-size: 0.6875rem;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .goal-mobile-show-phcs:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .goal-mobile-show-phcs:active {
            transform: scale(0.98);
        }
        
        .goal-mobile-phc-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .goal-mobile-phc-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .goal-mobile-phc-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.6875rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .goal-mobile-phc-overall-track {
            width: 100%;
            height: 3px;
            border-radius: 100px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .goal-mobile-phc-overall-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #4A90E2, #5BA3F5);
            transition: width 0.3s ease;
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        
        .sidebar h2 {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 10px;
        }
        
        .sidebar-menu a {
            display: block;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu a:hover {
            background: rgba(70, 130, 180, 0.3);
            border-color: rgba(70, 130, 180, 0.5);
            color: rgba(255, 255, 255, 1);
            transform: translateX(5px);
        }
        
        .sidebar-menu a.active {
            background: rgba(70, 130, 180, 0.4);
            border-color: rgba(70, 130, 180, 0.6);
            color: rgba(255, 255, 255, 1);
        }
        
        .sidebar-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }
        
        .sidebar-info p {
            margin-bottom: 10px;
        }
        
        /* Content Sections */
        .content-section {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Dashboard section - fixed to one screen, no scrolling */
        body.dashboard-active {
            overflow: hidden !important;
            height: 100vh !important;
        }
        
        #dashboard-section {
            height: calc(100vh - 44px - 40px); /* 100vh minus header (44px) minus body padding (20px top + 20px bottom) */
            max-height: calc(100vh - 44px - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #dashboard {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #mainCardsContainer {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: fit-content;
        }
        
        #dashboard-section .main-cards-container {
            height: 150px;
            flex-shrink: 0;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 0;
        }
        
        #dashboard-section .dashboard-pagination {
            flex-shrink: 0;
            margin-top: 8px;
            margin-bottom: 18px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        #dashboard-section .dashboard-pagination.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Zone List Container */
        #zoneListContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-bottom: 70px; /* Space for mobile footer (58px + safe area) */
        }
        
        .zone-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .zone-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .zone-item:hover {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-color: rgba(148, 163, 184, 0.3);
        }
        
        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .zone-name {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }
        
        .zone-target {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .zone-expand-icon {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            transition: transform 0.3s ease;
        }
        
        .zone-item.expanded .zone-expand-icon {
            transform: rotate(180deg);
        }
        
        .zone-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .zone-item.expanded .zone-details {
            display: block;
        }
        
        .zone-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }
        
        .zone-detail-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .zone-detail-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }
        
        .zone-detail-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
        }
        
        @media (max-width: 768px) {
            #zoneListContainer {
                max-height: calc(100vh - 48px - 20px - 150px - 18px - 40px - 70px); /* Subtract footer height */
                padding-bottom: 70px; /* Space for mobile footer */
            }
            
            .zone-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Placeholder Sheets */
        .placeholder-sheet {
            background: linear-gradient(135deg, rgba(90, 90, 90, 0.25) 0%, rgba(107, 107, 107, 0.25) 30%, rgba(74, 74, 74, 0.25) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 40px;
            min-height: 500px;
            text-align: center;
        }
        
        .placeholder-sheet::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        
        .placeholder-sheet h2 {
            color: rgba(255, 255, 255, 0.95);
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .placeholder-sheet p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            margin-bottom: 40px;
        }
        
        .placeholder-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .placeholder-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            transition: all 0.3s ease;
            cursor: default;
        }
        
        .placeholder-item:hover {
            background: rgba(70, 130, 180, 0.2);
            border-color: rgba(70, 130, 180, 0.4);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(70, 130, 180, 0.3);
        }
        
        /* KPI Card styling */
        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .kpi-toggle-btn.active {
            background: rgba(70, 130, 180, 0.8) !important;
            border-color: rgba(70, 130, 180, 0.6) !important;
            color: white !important;
        }
        
        .kpi-toggle-btn:not(.active) {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .kpi-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .main-content {
            flex: 1;
            min-width: 0;
        }
        .header {
            display: none;
        }
        .app-header {
            font-size: 35px;
            font-weight: 700;
            color: #60a5fa;
            text-align: center;
            margin: 16px auto 24px auto;
            padding: 0 20px;
            height: 48px;
            line-height: 48px;
            text-shadow: 0 2px 8px rgba(96, 165, 250, 0.5);
            display: block !important;
            position: relative;
            z-index: 100;
            width: 100%;
            box-sizing: border-box;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            padding: 20px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #loadingEnglish,
        #loadingArabic {
            min-height: 1.2em;
            position: relative;
        }
        #loadingArabic {
            font-family: 'Janna LT', 'JannaLT-Regular', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #loadingEnglish::after,
        #loadingArabic::after {
            content: '|';
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .main-cards-container {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding: 4px 0 8px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .main-cards-container::-webkit-scrollbar {
            display: none;
        }
        .main-cards-container .stat-card {
            flex: 0 0 80%;
            scroll-snap-align: center;
            height: 150px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Dashboard pagination dots - desktop */
        .dashboard-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 0;
            padding: 8px 16px;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .dashboard-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dashboard-dot.active {
            width: 20px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Hide pagination dots when dashboard section is not visible */
        #dashboard-section:not([style*="display: block"]) .dashboard-pagination,
        #dashboard-section[style*="display: none"] .dashboard-pagination {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .main-cards-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            /* Ensure body fits in viewport */
            body {
                padding: 10px;
                padding-top: 44px;
                overflow-x: hidden;
                overflow-y: auto;
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
            }
            
            /* Header hidden on mobile */
            .header {
                display: none;
            }
            
            /* App header styling for mobile */
            .app-header {
                font-size: 35px;
                margin-top: 16px;
                margin-bottom: 24px;
                margin-left: 10px;
                margin-right: 10px;
                display: block;
                width: calc(100% - 20px);
                position: relative;
                z-index: 10;
                padding: 0 16px;
                height: 48px;
                line-height: 48px;
            }
            .refresh-info {
                font-size: 0.7em;
                padding: 6px;
                margin-top: 8px;
            }
            
            /* Dashboard section - fixed to one screen on mobile, no scrolling */
            #dashboard-section {
                height: calc(100vh - 48px - 20px - 20px - 70px) !important; /* 100vh minus header (48px) minus margins (20px top + 20px bottom) minus footer (70px) */
                max-height: calc(100vh - 48px - 20px - 20px - 70px) !important;
                overflow: hidden !important;
                padding-bottom: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            #dashboard {
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            
            #mainCardsContainer {
                flex-shrink: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
                height: fit-content !important;
            }
            
            .main-cards-container {
                position: relative !important;
                height: 150px !important;
                flex-shrink: 0 !important;
                min-height: 150px !important;
                max-height: 150px !important;
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 12px !important;
                margin-bottom: 0 !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                padding: 4px 0 8px !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
                -ms-overflow-style: none !important;
            }
            .main-cards-container::-webkit-scrollbar {
                display: none !important;
            }
            .main-cards-container .stat-card {
                flex: 0 0 75% !important;
                scroll-snap-align: center !important;
                position: relative !important;
                opacity: 1 !important;
                visibility: visible !important;
                pointer-events: auto !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch !important;
                height: 150px !important;
                display: flex !important;
                flex-direction: column !important;
                align-self: stretch !important;
            }
            
            /* Mobile card navigation buttons - hidden, using swipe instead */
            .mobile-card-nav {
                display: none !important;
            }
            
            /* Dashboard pagination dots - positioned relative to cards */
            .dashboard-pagination {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 6px;
                margin-top: 8px !important;
                margin-bottom: 18px !important;
                padding: 8px 16px;
                background: rgba(30, 41, 59, 0.6);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                border: 1px solid rgba(148, 163, 184, 0.15);
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            
            .dashboard-pagination.visible {
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            
            .dashboard-dot {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transition: all 0.3s ease;
                cursor: pointer;
            }
            
            .dashboard-dot.active {
                width: 20px;
                height: 6px;
                border-radius: 3px;
                background: rgba(255, 255, 255, 0.9);
            }
            
            /* Hide pagination dots when dashboard section is not visible */
            #dashboard-section:not([style*="display: block"]) .dashboard-pagination,
            #dashboard-section[style*="display: none"] .dashboard-pagination {
                display: none !important;
            }
            
            .mobile-card-nav button {
                flex: 1;
                padding: 8px 12px;
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 6px;
                color: white;
                font-size: 0.75em;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 500;
                white-space: nowrap;
            }
            
            .mobile-card-nav button.active {
                background: rgba(70, 130, 180, 0.6);
                border-color: rgba(70, 130, 180, 0.8);
                box-shadow: 0 2px 8px rgba(70, 130, 180, 0.4);
            }
            
            .mobile-card-nav button:active {
                transform: scale(0.95);
            }
            
            /* Ensure container fits in viewport */
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            /* Hide sidebar on mobile */
            .sidebar {
                display: none;
            }
            
            /* Show bottom tab bar on mobile */
            .mobile-tab-bar {
                display: flex;
            }
            
            /* Daily KPI mobile-friendly styles */
            #dm-patients-section .placeholder-sheet {
                padding: 20px 16px;
            }
            
            #dm-patients-section .placeholder-sheet h2 {
                font-size: 1.5em;
                margin-bottom: 16px;
            }
            
            /* Toggle buttons container */
            .kpi-toggle-container {
                display: flex !important;
                gap: 8px !important;
                justify-content: center !important;
                margin-bottom: 20px !important;
            }
            
            /* Toggle buttons - equal width on mobile */
            .kpi-toggle-btn {
                flex: 1 !important;
                max-width: 200px;
                padding: 10px 16px !important;
                font-size: 0.9em !important;
                margin: 0 !important;
            }
            
            /* Date picker container - stack on mobile */
            .kpi-form-container {
                display: flex !important;
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            /* Date groups - stack on mobile */
            .kpi-date-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            /* Labels and inputs - full width on mobile */
            .kpi-label {
                display: block !important;
                margin-bottom: 8px !important;
                margin-right: 0 !important;
                font-size: 0.9em !important;
            }
            
            .kpi-date-input {
                width: 100% !important;
                min-width: unset !important;
                margin-right: 0 !important;
                margin-bottom: 0 !important;
                font-size: 0.9em !important;
                padding: 10px 12px !important;
                box-sizing: border-box !important;
            }
            
            /* Generate buttons - full width on mobile */
            .kpi-generate-btn {
                width: 100% !important;
                margin-left: 0 !important;
                padding: 12px 20px !important;
                font-size: 0.95em !important;
                box-sizing: border-box !important;
            }
            
            /* Summary table container - horizontal scroll on mobile */
            #dailySummaryTable,
            #weeklySummaryTable {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-top: 20px !important;
            }
            
            /* Table styling for mobile */
            #dailySummaryTable table,
            #weeklySummaryTable table {
                font-size: 0.8em;
                min-width: 600px; /* Ensure table has minimum width for scrolling */
            }
            
            #dailySummaryTable table th,
            #dailySummaryTable table td,
            #weeklySummaryTable table th,
            #weeklySummaryTable table td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            /* KPI card padding reduced on mobile */
            .kpi-card {
                padding: 16px !important;
            }
            
            /* Goals: use stacked cards + toggle on mobile */
            .goals-desktop-table {
                display: none;
            }
            
            .goals-mobile-cards {
                display: flex;
            }
            
            .main-content {
                width: 100%;
            }
            
            /* Placeholder sheets on mobile */
            .placeholder-sheet {
                padding: 16px;
                min-height: auto;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
            
            .placeholder-sheet h2 {
                font-size: 1.25rem;
                margin-bottom: 12px;
                font-weight: 600;
            }
            
            .placeholder-sheet p {
                font-size: 0.875rem;
                margin-bottom: 16px;
                color: rgba(255, 255, 255, 0.75);
            }
            
            .placeholder-content {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-top: 30px;
            }
            
            .placeholder-item {
                padding: 20px 15px;
                font-size: 0.95em;
            }
            
            /* Adjust card padding on mobile - more compact */
            .stat-card {
                padding: 10px !important;
                min-height: 144px !important;
                height: 144px !important;
                max-height: 144px !important;
            }
            
            /* Ensure all cards have consistent sizing - smaller width */
            .main-cards-container .stat-card {
                width: 75% !important;
                max-width: 75% !important;
            }
            
            /* Make charts more compact on mobile - reduced by 15% total */
            .stat-card h3 {
                font-size: 0.86em !important;
                margin-bottom: 7px !important;
            }
            
            /* Reduce all font sizes in mobile cards - more compact */
            .main-cards-container .stat-card [style*="font-size: 1.5em"] {
                font-size: 1.1em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 0.75em"] {
                font-size: 0.64em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 1em"] {
                font-size: 0.86em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 0.65em"] {
                font-size: 0.56em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 0.9em"] {
                font-size: 0.77em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 0.6em"] {
                font-size: 0.51em !important;
            }
            .main-cards-container .stat-card [style*="font-size: 0.8em"] {
                font-size: 0.68em !important;
            }
            
            /* Reduce gaps and margins - more compact */
            .main-cards-container .stat-card > div[style*="gap: 10px"] {
                gap: 6px !important;
            }
            .main-cards-container .stat-card > div[style*="gap: 12px"] {
                gap: 8px !important;
            }
            .main-cards-container .stat-card [style*="margin-top: 10px"] {
                margin-top: 6px !important;
            }
            .main-cards-container .stat-card [style*="margin-top: 15px"] {
                margin-top: 10px !important;
            }
            .main-cards-container .stat-card [style*="margin-top: 12px"] {
                margin-top: 8px !important;
            }
            .main-cards-container .stat-card [style*="margin-bottom: 15px"] {
                margin-bottom: 10px !important;
            }
            .main-cards-container .stat-card [style*="margin-bottom: 12px"] {
                margin-bottom: 8px !important;
            }
            .main-cards-container .stat-card [style*="margin-bottom: 8px"] {
                margin-bottom: 6px !important;
            }
            .main-cards-container .stat-card [style*="margin-bottom: 5px"] {
                margin-bottom: 5px !important;
            }
            .main-cards-container .stat-card [style*="margin-bottom: 2px"] {
                margin-bottom: 2px !important;
            }
            .main-cards-container .stat-card [style*="padding: 12px"] {
                padding: 10px !important;
            }
            .main-cards-container .stat-card [style*="padding-top: 8px"] {
                padding-top: 7px !important;
            }
            .main-cards-container .stat-card [style*="margin-top: 8px"] {
                margin-top: 7px !important;
            }
            
            /* Reduce chart heights by 15% total */
            .main-cards-container .stat-card [style*="height: 144px"] {
                height: 122px !important;
            }
            .main-cards-container .stat-card [style*="height: 200px"] {
                height: 122px !important;
            }
            .main-cards-container .stat-card [style*="height: 250px"] {
                height: 214px !important;
            }
            .main-cards-container .stat-card [style*="min-height: 240px"] {
                min-height: 205px !important;
            }
            .main-cards-container .stat-card [style*="min-height: 300px"] {
                min-height: 257px !important;
            }
            
            /* Building Visualization mobile styles */
            .building-viz-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            .building-viz-card {
                padding: 12px !important;
            }
            
            .building-viz-card h3,
            .building-viz-card .goal-mobile-title {
                font-size: 0.875rem !important;
                margin-bottom: 10px !important;
            }
            
            .building-viz-card [style*="font-size: 1.5em"] {
                font-size: 1.1em !important;
            }
            
            .building-viz-card [style*="font-size: 0.75rem"] {
                font-size: 0.7rem !important;
            }
            
            .building-viz-card [style*="font-size: 0.7rem"] {
                font-size: 0.65rem !important;
            }
            
            .building-viz-card canvas {
                max-height: 120px !important;
            }
            
            #buildingBreadcrumb {
                padding: 8px 10px !important;
                font-size: 0.75rem !important;
                margin-bottom: 12px !important;
            }
            
            /* Ensure text wrapping in sub-cards and sub-sub-cards */
            .stat-sub-card,
            .stat-sub-card *,
            .sub-sub-card,
            .sub-sub-card * {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                hyphens: auto !important;
            }
            .stat-sub-card > *,
            .sub-sub-card > * {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            .stat-sub-card-front,
            .stat-sub-card-back,
            .sub-sub-card-front,
            .sub-sub-card-back {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                overflow: hidden !important;
            }
            .stat-sub-card-front > div,
            .sub-sub-card-front > div {
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 100% !important;
            }
            
            /* Adjust loading font size on mobile */
            .loading {
                font-size: 0.81em;
                padding: 11px;
            }
            
        }
        
        /* Hide mobile nav on desktop */
        .mobile-card-nav {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-card-nav {
                display: flex;
            }
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(90, 90, 90, 0.25) 0%, rgba(107, 107, 107, 0.25) 30%, rgba(74, 74, 74, 0.25) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Building Visualization Grid */
        .building-viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .building-viz-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        .stat-card h3 {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card .value {
            color: rgba(255, 255, 255, 0.95);
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        .chart-card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .full-width .chart-container {
            height: 400px;
        }
        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }
        .refresh-info {
            background: rgba(255,255,255,0.15);
            color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-sub-card {
            cursor: pointer;
            perspective: 1000px;
            min-height: 140px;
        }
        .stat-sub-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 140px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .stat-sub-card.flipped .stat-sub-card-inner {
            transform: rotateY(180deg);
        }
        .stat-sub-card-front,
        .stat-sub-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        .stat-sub-card-front {
            text-align: center;
        }
        .stat-sub-card-back {
            text-align: center;
            transform: rotateY(180deg);
            font-size: 0.65em;
            opacity: 0.8;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stat-sub-card:not(.flipped):hover .stat-sub-card-inner {
            transform: translateY(-2px);
        }
        .stat-sub-card.flipped:hover .stat-sub-card-inner {
            transform: rotateY(180deg);
        }
        
        /* No-flip card styling - prevents flipping */
        .stat-sub-card.no-flip-card {
            cursor: default;
            height: 144px !important;
            min-height: 144px !important;
        }
        .stat-sub-card.no-flip-card .stat-sub-card-inner {
            transform: none !important;
            height: 100% !important;
        }
        .stat-sub-card.no-flip-card:hover .stat-sub-card-inner {
            transform: none !important;
        }
        .stat-sub-card.no-flip-card .stat-sub-card-front {
            position: relative;
            transform: none;
            height: 100% !important;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Alert card styling - reddish alert without animation or glow */
        .stat-sub-card.alert-card .stat-sub-card-front,
        .stat-sub-card.alert-card .stat-sub-card-back {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.5) 0%, rgba(220, 53, 69, 0.45) 50%, rgba(198, 40, 40, 0.4) 100%) !important;
            border: 2px solid rgba(244, 67, 54, 0.6);
        }
        
        /* Success card styling - greenish gradient without animation or glow */
        .stat-sub-card.success-card .stat-sub-card-front,
        .stat-sub-card.success-card .stat-sub-card-back {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.5) 0%, rgba(60, 115, 160, 0.45) 50%, rgba(50, 100, 140, 0.4) 100%) !important;
            border: 2px solid rgba(70, 130, 180, 0.6);
        }
        
        /* Sub-sub-card styling - nested cards inside main sub-cards */
        .sub-sub-cards-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 8px;
        }
        .sub-sub-card {
            cursor: pointer;
            perspective: 800px;
            min-height: 55px;
            max-height: 55px;
            height: 55px;
        }
        .sub-sub-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 55px;
            max-height: 55px;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .sub-sub-card.flipped .sub-sub-card-inner {
            transform: rotateY(180deg);
        }
        .sub-sub-card-front,
        .sub-sub-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 55px;
            max-height: 55px;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 6px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
            text-align: center;
        }
        .sub-sub-card-back {
            transform: rotateY(180deg);
            font-size: 0.5em;
            opacity: 0.8;
            line-height: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sub-sub-card:not(.flipped):hover .sub-sub-card-inner {
            transform: translateY(-2px);
        }
        .sub-sub-card.flipped:hover .sub-sub-card-inner {
            transform: rotateY(180deg);
        }
        .sub-sub-card.success-card .sub-sub-card-front,
        .sub-sub-card.success-card .sub-sub-card-back {
            background: linear-gradient(135deg, rgba(70, 130, 180, 0.45) 0%, rgba(60, 115, 160, 0.4) 50%, rgba(50, 100, 140, 0.35) 100%) !important;
            border: 2px solid rgba(70, 130, 180, 0.55);
        }
        .sub-sub-card.alert-card .sub-sub-card-front,
        .sub-sub-card.alert-card .sub-sub-card-back {
            background: linear-gradient(135deg, rgba(244, 67, 54, 0.45) 0%, rgba(220, 53, 69, 0.4) 50%, rgba(198, 40, 40, 0.35) 100%) !important;
            border: 2px solid rgba(244, 67, 54, 0.55);
        }
    </style>
</head>
<body>
    
    <h1 class="app-header">Najran PHM</h1>
    
    <div class="container">
        <aside class="sidebar">
            <h2>Navigation</h2>
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="sidebar-link" data-section="dashboard">Dashboard</a></li>
                <li><a href="#dm-patients" class="sidebar-link" data-section="dm-patients">KPIs</a></li>
                <li><a href="#pre-dm-patients" class="sidebar-link" data-section="pre-dm-patients">Goals</a></li>
                <li><a href="#screening-target" class="sidebar-link" data-section="screening-target">Target</a></li>
            </ul>
            <div class="sidebar-info">
                <p><strong>منظور | Manthoor</strong></p>
                <p>Pre-DM Tracker Dashboard</p>
                <p id="sidebarLastUpdate" style="font-size: 0.9em; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);"></p>
            </div>
        </aside>
        
        <div class="main-content">

        <div id="loading" class="loading">
            <div id="loadingEnglish"></div>
            <div id="loadingArabic"></div>
        </div>
        <div id="error" class="error" style="display: none;"></div>

            <!-- Dashboard Section (default) -->
            <div id="dashboard-section" class="content-section" style="display: none;">
                <div id="dashboard">
            <div id="mainCardsContainer"></div>
                    <div id="zoneListContainer"></div>
        </div>
    </div>

            <!-- DM Patients Section (Daily KPI) -->
            <div id="dm-patients-section" class="content-section" style="display: none;">
                <div class="placeholder-sheet" style="margin-top: 0;">
                    <h2>Daily KPI</h2>
                    
                    <!-- Toggle buttons -->
                    <div class="kpi-toggle-container" style="margin-bottom: 30px; text-align: center;">
                        <button id="toggleDaily" class="kpi-toggle-btn active" style="padding: 12px 30px; margin: 0 10px; border-radius: 8px; border: 2px solid rgba(70, 130, 180, 0.6); background: rgba(70, 130, 180, 0.8); color: white; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Daily</button>
                        <button id="toggleWeekly" class="kpi-toggle-btn" style="padding: 12px 30px; margin: 0 10px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.9); font-size: 1.1em; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Weekly</button>
                    </div>
                    
                    <!-- Daily Card -->
                    <div id="dailyCard" class="kpi-card" style="display: block;">
                        <div class="kpi-form-container" style="margin-bottom: 30px;">
                            <label for="dailyDatePicker" class="kpi-label" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em; margin-right: 15px; display: inline-block;">Select Date:</label>
                            <input type="date" id="dailyDatePicker" class="kpi-date-input" style="padding: 10px 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.95); font-size: 1em; cursor: pointer; min-width: 200px;">
                            <button id="generateDailySummary" class="kpi-generate-btn" style="margin-left: 15px; padding: 10px 25px; border-radius: 8px; border: none; background: rgba(70, 130, 180, 0.8); color: white; font-size: 1em; cursor: pointer; font-weight: bold; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(70, 130, 180, 1)'" onmouseout="this.style.background='rgba(70, 130, 180, 0.8)'">Generate Summary</button>
                        </div>
                        <div id="dailySummaryTable" style="margin-top: 30px;">
                            <p style="color: rgba(255, 255, 255, 0.7); font-style: italic; font-size: 0.9em;">Please select a date and click "Generate Summary" to view the daily screening summary.</p>
                        </div>
                    </div>
                    
                    <!-- Weekly Card -->
                    <div id="weeklyCard" class="kpi-card" style="display: none;">
                        <div class="kpi-form-container" style="margin-bottom: 30px;">
                            <div class="kpi-date-group" style="margin-bottom: 15px;">
                                <label for="weeklyDateFrom" class="kpi-label" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em; margin-right: 15px; display: inline-block;">From Date:</label>
                                <input type="date" id="weeklyDateFrom" class="kpi-date-input" style="padding: 10px 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.95); font-size: 1em; cursor: pointer; min-width: 200px; margin-right: 20px;">
                            </div>
                            <div class="kpi-date-group" style="margin-bottom: 15px;">
                                <label for="weeklyDateTo" class="kpi-label" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1em; margin-right: 15px; display: inline-block;">To Date:</label>
                                <input type="date" id="weeklyDateTo" class="kpi-date-input" style="padding: 10px 15px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.95); font-size: 1em; cursor: pointer; min-width: 200px;">
                            </div>
                            <button id="generateWeeklySummary" class="kpi-generate-btn" style="padding: 10px 25px; border-radius: 8px; border: none; background: rgba(70, 130, 180, 0.8); color: white; font-size: 1em; cursor: pointer; font-weight: bold; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(70, 130, 180, 1)'" onmouseout="this.style.background='rgba(70, 130, 180, 0.8)'">Generate Summary</button>
                        </div>
                        <div id="weeklySummaryTable" style="margin-top: 30px;">
                            <p style="color: rgba(255, 255, 255, 0.7); font-style: italic; font-size: 0.9em;">Please select a date range (From - To) and click "Generate Summary" to view the weekly screening summary.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pre-DM Patients Section (Goals) -->
            <div id="pre-dm-patients-section" class="content-section" style="display: none;">
                <div class="placeholder-sheet">
                    <h2>Goals</h2>
                    <p>This section displays alignment of DM, Pre-DM, and screening KPIs with strategic goals.</p>
                    <div class="placeholder-content">
                        <div class="placeholder-item">Patient List</div>
                        <div class="placeholder-item">Screening Results</div>
                        <div class="placeholder-item">Follow-up Schedule</div>
                        <div class="placeholder-item">Progress Tracking</div>
                    </div>
                </div>
            </div>

            <!-- Screening Target Section -->
            <div id="screening-target-section" class="content-section" style="display: none;">
                <div class="placeholder-sheet">
                    <h2>Placeholder 3</h2>
                    <p>This section will display screening target information and progress.</p>
                    <div class="placeholder-content">
                        <div class="placeholder-item">Target Overview</div>
                        <div class="placeholder-item">Progress by Zone</div>
                        <div class="placeholder-item">Progress by PHC</div>
                        <div class="placeholder-item">Remaining Targets</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Mobile bottom tab bar (words instead of icons) -->
    <nav class="mobile-tab-bar">
        <div class="mobile-tab-pill">
            <button class="mobile-tab-link active" data-section="dashboard">Dashboard</button>
            <button class="mobile-tab-link" data-section="dm-patients">KPIs</button>
            <button class="mobile-tab-link" data-section="pre-dm-patients">Goals</button>
            <button class="mobile-tab-link" data-section="screening-target">Target</button>
        </div>
    </nav>

    <script>
        // Google Sheets CSV export URL
        const sheetId = '1bkFe79GR9vkXz4ziZ2bMSGER9NkIMfBrZ7g8x6MDFtM';
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
        
        // CORS proxy URLs (try multiple in case one fails)
        const corsProxies = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];

        let charts = {};
        let proxyIndex = 0;
        let typingAnimationTimer = null;
        
        // Typing animation function
        function startTypingAnimation() {
            const loadingEnglish = document.getElementById('loadingEnglish');
            const loadingArabic = document.getElementById('loadingArabic');
            if (!loadingEnglish || !loadingArabic) return;
            
            // Clear any existing animation timer
            if (typingAnimationTimer) {
                clearTimeout(typingAnimationTimer);
            }
            
            // Fixed prefixes
            const englishPrefix = 'Manthoor ';
            const arabicPrefix = 'منظور';
            
            // Animated suffixes
            const englishSuffix = '...data drives decision';
            const arabicSuffix = '...البيانات تدعم القرار';
            
            let currentIndex = 0;
            let isDeleting = false;
            
            function type() {
                if (isDeleting) {
                    // Delete characters from suffixes only
                    const englishSuffixDisplay = englishSuffix.substring(0, currentIndex - 1);
                    const arabicSuffixDisplay = arabicSuffix.substring(0, currentIndex - 1);
                    loadingEnglish.textContent = englishPrefix + englishSuffixDisplay;
                    loadingArabic.textContent = arabicPrefix + arabicSuffixDisplay;
                    currentIndex--;
                    
                    if (currentIndex === 0) {
                        isDeleting = false;
                        // Add a small delay before starting to type again
                        typingAnimationTimer = setTimeout(type, 500);
                        return;
                    }
                    typingAnimationTimer = setTimeout(type, 50); // Faster deletion
                } else {
                    // Type characters in suffixes only
                    const englishSuffixDisplay = englishSuffix.substring(0, currentIndex + 1);
                    const arabicSuffixDisplay = arabicSuffix.substring(0, currentIndex + 1);
                    loadingEnglish.textContent = englishPrefix + englishSuffixDisplay;
                    loadingArabic.textContent = arabicPrefix + arabicSuffixDisplay;
                    currentIndex++;
                    
                    if (currentIndex === englishSuffix.length) {
                        // Wait a bit at the end, then start deleting
                        typingAnimationTimer = setTimeout(() => {
                            isDeleting = true;
                            type();
                        }, 2000); // Wait 2 seconds before deleting
                        return;
                    }
                    typingAnimationTimer = setTimeout(type, 100); // Typing speed
                }
            }
            
            // Start the animation
            type();
        }

        // Load and process data
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                // Start typing animation when loading
                startTypingAnimation();

                let csvText = null;
                let lastError = null;

                // Try direct fetch first
                try {
                    const response = await fetch(csvUrl);
                    if (response.ok) {
                        csvText = await response.text();
                    } else {
                        throw new Error('Direct fetch failed');
                    }
                } catch (directError) {
                    // If direct fetch fails, try CORS proxies
                    for (let i = 0; i < corsProxies.length; i++) {
                        try {
                            const proxyUrl = corsProxies[i] + encodeURIComponent(csvUrl);
                            const response = await fetch(proxyUrl);
                            if (response.ok) {
                                csvText = await response.text();
                                break;
                            }
                        } catch (proxyError) {
                            lastError = proxyError;
                            continue;
                        }
                    }
                }

                if (!csvText) {
                    throw new Error('Failed to fetch data from all sources. Please ensure the Google Sheet is publicly accessible.');
                }
                
                // Process data stream - only calculate what we need
                processDataStream(csvText);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Error loading data:</strong> ${error.message}<br><br>
                    <strong>To fix this:</strong><br>
                    1. Open your Google Sheet<br>
                    2. Click "Share" (top right)<br>
                    3. Click "Change to anyone with the link"<br>
                    4. Set permission to "Viewer"<br>
                    5. Click "Done"<br>
                    6. Refresh this page
                `;
            }
        }

        // Normalize organization name function (used globally)
        function normalizeOrgName(org) {
            if (!org) return "";
            return org.toString().trim().toLowerCase().split(/\s+/).join(" ");
        }
        
        // Official screening targets per PHC (organization) and per zone
        // Source provided by user as the authoritative table.
        const ORG_TARGETS_DATA = [
            { zone: "BGH",  name: "AL- qarn",                                   target: 6    },
            { zone: "BGH",  name: "Hadadah health center",                     target: 537  },
            { zone: "BGH",  name: "Primary Care Alkhaniq",                     target: 714  },
            { zone: "BGH",  name: "alrehab Primary care center",               target: 188  },
            { zone: "BGH",  name: "bader aljanoob primary health care",        target: 1021 },
            { zone: "BGH",  name: "maleha public health center",               target: 140  },
            { zone: "HGH",  name: "AL JAFFAH PHCC",                            target: 583  },
            { zone: "HGH",  name: "ALMONTSHER  PHCC",                          target: 1013 },
            { zone: "HGH",  name: "Habuna primary Health Care Center",        target: 2579 },
            { zone: "HGH",  name: "al harshar phcc",                           target: 439  },
            { zone: "HGH",  name: "dekah",                                     target: 1311 },
            { zone: "HGH",  name: "majma",                                     target: 694  },
            { zone: "KGH",  name: "AL-SHARAA",                                 target: 1244 },
            { zone: "KGH",  name: "KHUBASH Health center",                     target: 1805 },
            { zone: "KGH",  name: "Primary Health Care Center GOILLA",         target: 3129 },
            { zone: "KGH",  name: "junoob matar",                              target: 1191 },
            { zone: "KGH",  name: "mishaliya",                                 target: 5020 },
            { zone: "KGH",  name: "taslal health center",                      target: 1825 },
            { zone: "KKH",  name: "ALDUBAT PHCC",                              target: 7470 },
            { zone: "KKH",  name: "Al Faisaliah Health Center",                target: 3060 },
            { zone: "KKH",  name: "Aqfah phcc",                                target: 542  },
            { zone: "KKH",  name: "Biraskar phcc",                             target: 1409 },
            { zone: "KKH",  name: "Primary Health Care Center DIYAFA",         target: 1108 },
            { zone: "KKH",  name: "al contub",                                 target: 1159 },
            { zone: "KKH",  name: "khaldiya health center",                    target: 3427 },
            { zone: "KKH",  name: "primary health care center north",          target: 8413 },
            { zone: "KKH",  name: "prince mishal health center",               target: 4103 },
            { zone: "MCH",  name: "al fahad al janubi phcc",                   target: 4924 },
            { zone: "MCH",  name: "atheabah phcc",                             target: 6910 },
            { zone: "WNH",  name: "Al Safa Health Center",                     target: 1048 },
            { zone: "WNH",  name: "Al muratah phcc",                           target: 835  },
            { zone: "WNH",  name: "Alhadan PHCC",                              target: 6018 },
            { zone: "WNH",  name: "Health Center algabil",                     target: 5311 },
            { zone: "WNH",  name: "Health center in aljurbah",                 target: 1450 },
            { zone: "WNH",  name: "PHCC Abasoud",                              target: 3289 },
            { zone: "WNH",  name: "albalad",                                   target: 1428 },
            { zone: "WNH",  name: "dahada helth center",                       target: 5207 },
            { zone: "WNH",  name: "eam phcc reer",                             target: 1875 },
            { zone: "WNH",  name: "health center al mufja",                    target: 507  },
            { zone: "NNGH", name: "Al Arisa Health Center",                    target: 5696 },
            { zone: "NNGH", name: "Alhamar phcc",                              target: 1170 },
            { zone: "NNGH", name: "HUSSAINIAH PHCC",                           target: 1385 },
            { zone: "NNGH", name: "Primary Health Care Center in Nhogah",      target: 930  },
            { zone: "NNGH", name: "RIJLA PHcc",                                target: 961  },
            { zone: "NNGH", name: "Shebhan phcc",                              target: 847  },
            { zone: "NNGH", name: "primary health care center barrk",          target: 1593 },
            { zone: "NNGH", name: "primary health care center of shurfa",      target: 5234 },
            { zone: "SGH",  name: "Alakashim Health Center",                   target: 259  },
            { zone: "SGH",  name: "Aziziyah PHCC Sharoora",                    target: 5105 },
            { zone: "SGH",  name: "RAWDAH phcc Sharoora",                      target: 3325 },
            { zone: "SGH",  name: "Security Forces PHCC Sharoora",             target: 375  },
            { zone: "SGH",  name: "Sultanaa PHCC Sharoora",                    target: 4287 },
            { zone: "SGH",  name: "Tamani phcc Sharoura",                      target: 6    },
            { zone: "SGH",  name: "Wadi Riman Health Center",                  target: 3499 },
            { zone: "SGH",  name: "alwadia phcc sharoora",                     target: 1885 },
            { zone: "SGH",  name: "khaldiya sharoorah health center",          target: 1920 },
            { zone: "TGH",  name: "hema phcc",                                 target: 211  },
            { zone: "TGH",  name: "naiwan phcc",                               target: 290  },
            { zone: "TGH",  name: "qattan phcc",                               target: 201  },
            { zone: "TGH",  name: "suffah phcc",                               target: 390  },
            { zone: "TGH",  name: "talham phcc",                               target: 138  },
            { zone: "TGH",  name: "thar phcc",                                 target: 1300 },
            { zone: "YGH",  name: "legam primary health care center",          target: 601  },
            { zone: "YGH",  name: "mohammadia phcc",                           target: 295  },
            { zone: "YGH",  name: "sultana primaryhealth care center",         target: 413  },
            { zone: "YGH",  name: "tilah phcc",                                target: 117  },
            { zone: "YGH",  name: "wadi wasat",                                target: 242  },
            { zone: "YGH",  name: "yadama primary health care center",         target: 2020 }
        ];
        
        // Build normalized org target lookup and aggregate zone totals from the PHC table
        const ORG_TARGETS = {}; // normalizeOrgName(org) -> { zone, target }
        const TOTAL_CUMULATIVE_TARGETS = {}; // zone -> total target
        
        ORG_TARGETS_DATA.forEach(entry => {
            const key = normalizeOrgName(entry.name);
            ORG_TARGETS[key] = { zone: entry.zone, target: entry.target };
            if (!TOTAL_CUMULATIVE_TARGETS[entry.zone]) {
                TOTAL_CUMULATIVE_TARGETS[entry.zone] = 0;
            }
            TOTAL_CUMULATIVE_TARGETS[entry.zone] += entry.target;
        });
        
        function getOrgTarget(org) {
            const key = normalizeOrgName(org);
            const entry = ORG_TARGETS[key];
            return entry ? entry.target : 0;
        }

        function processDataStream(csvText) {
            // Initialize counters - only store what we need
            let totalRecords = 0;
            const patientSet = new Set();
            const orgSet = new Set();
            const testSet = new Set();
            let latestResultDate = null;
            
            // DM thresholds (same as Python code)
            const DM_THRESHOLDS = { "HBA1C": 6.5, "FASTING": 7.0 };
            const CONTROL_MAX = { "HBA1C": 8.0, "FASTING": 9.0 };
            const DM_FIRST_RESULT_CUTOFF = new Date("2025-06-01");
            
            // Pre-DM ranges (same as Python code)
            const PRE_DM_RANGES = { "HBA1C": [5.7, 6.4], "FASTING": [5.6, 6.9] };
            const PRE_DM_DATE_CUTOFF = new Date("2025-01-01");
            
            // Daily targets by zone (from Python code)
            const DAILY_TARGETS = {
                "KKH": 225,
                "MCH": 80,
                "BGH": 75,
                "TGH": 75,
                "HGH": 100,
                "KGH": 150,
                "SGH": 200,
                "WNH": 325,
                "NNGH": 200,
                "YGH": 75
            };
            
            // Screening start date (from Python code)
            const SCREENING_START_DATE = new Date("2025-01-01");
            
            // Store patient records for DM calculation
            const patientRecords = {}; // patient_id -> array of records
            const patientOrganizations = {}; // patient_id -> organization name
            
            // Store all patient data for daily summary (full records with all fields)
            const allPatientData = []; // Array of all patient records with full details
            const hasDmIds = new Set(); // Will be populated from HAS DM file if available
            
            // Zone mapping (from Python code)
            const ORG_ZONE_MAP = {
                        "alrehab primary care center": "BGH",
                        "bader aljanoob primary health care": "BGH",
                        "hadadah health center": "BGH",
                        "maleha public health center": "BGH",
                        "primary care alkhaniq": "BGH",
                        "al harshar phcc": "HGH",
                        "al jaffah phcc": "HGH",
                        "almontsher phcc": "HGH",
                        "dekah": "HGH",
                        "habuna primary health care center": "HGH",
                        "majma": "HGH",
                        "alsharaa": "KGH",
                        "al-sharaa": "KGH",
                        "junoob matar": "KGH",
                        "khubash health center": "KGH",
                        "mishaliya": "KGH",
                        "taslal health center": "KGH",
                        "al contub": "KKH",
                        "al faisaliah health center": "KKH",
                        "aldubat phcc": "KKH",
                        "aqfah phcc": "KKH",
                        "biraskar phcc": "KKH",
                        "khaldiya health center": "KKH",
                        "primary health care center diyafa": "KKH",
                        "primary health care center goilla": "KGH",
                        "primary health care center north": "KKH",
                        "prince mishal health center": "KKH",
                        "al fahad al janubi phcc": "MCH",
                        "atheabah phcc": "MCH",
                        "al arisa health center": "NNGH",
                        "alhamar phcc": "NNGH",
                        "hussainiah phcc": "NNGH",
                        "primary health care center barrk": "NNGH",
                        "primary health care center of shurfa": "NNGH",
                        "rijla phcc": "NNGH",
                        "wadi riman health center": "NNGH",
                        "alakashim health center": "SGH",
                        "alwadia phcc sharoora": "SGH",
                        "aziziyah phcc sharoora": "SGH",
                        "rawdah phcc sharoora": "SGH",
                        "security forces phcc sharoora": "SGH",
                        "sultanaa phcc sharoora": "SGH",
                        "sultaa phcc sharoora": "SGH",
                        "khaldiya sharoorah health center": "SGH",
                        "hema phcc": "TGH",
                        "naiwan phcc": "TGH",
                        "qattan phcc": "TGH",
                        "suffah phcc": "TGH",
                        "talham phcc": "TGH",
                        "thar phcc": "TGH",
                        "tilah phcc": "TGH",
                        "al muratah phcc": "WNH",
                        "al safa health center": "WNH",
                        "albalad": "WNH",
                        "alhadan phcc": "WNH",
                        "dahada helth center": "WNH",
                        "eam phcc reer": "WNH",
                        "health center al mufja": "WNH",
                        "health center algabil": "WNH",
                        "health center in aljurbah": "WNH",
                        "phcc abasoud": "WNH",
                        "primary health care center in nhogah": "WNH",
                        "shebhan phcc": "WNH",
                        "legam primary health care center": "YGH",
                        "mohammadia phcc": "YGH",
                        "sultana primaryhealth care center": "YGH",
                        "wadi wasat": "YGH",
                        "yadama primary health care center": "YGH"
                    };
                    
                    // Create zone lookup
                    const ZONE_LOOKUP = {};
                    for (const [org, zone] of Object.entries(ORG_ZONE_MAP)) {
                        ZONE_LOOKUP[normalizeOrgName(org)] = zone;
                    }
                    
                    function inferZone(org) {
                        return ZONE_LOOKUP[normalizeOrgName(org)] || "Unknown";
                    }

            // Process CSV row by row - stream processing
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                step: function(row) {
                    const data = row.data;
                    
                    // Skip if no Patient_ID
                    if (!data.Patient_ID) return;
                    
                    // Count records
                    totalRecords++;
                    
                    // Count unique patients
                    if (data.Patient_ID) patientSet.add(data.Patient_ID);
                    
                    // Store patient record for DM calculation
                    if (!patientRecords[data.Patient_ID]) {
                        patientRecords[data.Patient_ID] = [];
                    }
                    const resultDate = data['Result Date'] ? new Date(data['Result Date']) : null;
                    if (resultDate && !isNaN(resultDate.getTime())) {
                        if (!latestResultDate || resultDate > latestResultDate) {
                            latestResultDate = resultDate;
                        }
                    }
                    const age = parseInt(data.Age) || 0;
                    // Try multiple possible column names for date of birth
                    const dobRaw = data['Date Of Birth'] || data['DateOfBirth'] || data['DOB'] || data['Conformed Patient - Patient Key → Date Of Birth'];
                    const dobDate = dobRaw ? new Date(dobRaw) : null;
                    
                    patientRecords[data.Patient_ID].push({
                        resultName: data['Result Name'] || '',
                        resultValue: parseFloat(data.ResultValue) || 0,
                        resultDate: resultDate,
                        age: age
                    });
                    
                    // Store full patient data for daily summary
                    const resultNameLower = (data['Result Name'] || '').toLowerCase();
                    const resultType = resultNameLower.includes('a1c') ? 'HBA1C' : 
                                      (resultNameLower.includes('fast') ? 'FASTING' : 'OTHER');
                    
                    allPatientData.push({
                        patientId: data.Patient_ID,
                        organization: data['Organization Name'] || '',
                        dob: dobDate,
                        age: age,
                        gender: data.Gender || '',
                        resultName: data['Result Name'] || '',
                        resultType: resultType,
                        resultDate: resultDate,
                        resultValue: parseFloat(data.ResultValue) || 0
                    });
                    
                    // Store organization for patient
                    if (data['Organization Name']) {
                        patientOrganizations[data.Patient_ID] = data['Organization Name'];
                    }
                    
                    // Count unique organizations
                    if (data['Organization Name']) {
                        orgSet.add(data['Organization Name']);
                    }
                    
                    // Count unique test types
                    if (data['Result Name']) {
                        testSet.add(data['Result Name']);
                    }
                },
                complete: function() {
                    // Store data globally for daily summary
                    globalAllPatientData = allPatientData;
                    globalHasDmIds = hasDmIds;
                    globalOrgZoneMap = ORG_ZONE_MAP;
                    
                    // Create zone lookup for daily summary
                    function normalizeOrgNameForLookup(org) {
                        if (!org) return "";
                        return org.toString().trim().toLowerCase().split(/\s+/).join(" ");
                    }
                    globalZoneLookup = {};
                    for (const [org, zone] of Object.entries(ORG_ZONE_MAP)) {
                        globalZoneLookup[normalizeOrgNameForLookup(org)] = zone;
                    }
                    
                    const totalPatients = patientSet.size;
                    const orgCount = orgSet.size;
                    const testCount = testSet.size;
                    
                    // Calculate DM patients (same logic as Python code)
                    const dmFirstDates = {}; // patient_id -> first DM date
                    const dmPatients = {}; // patient_id -> {firstDMDate, latestResult}
                    
                    // Find first DM result date and latest result for each patient
                    for (const [patientId, records] of Object.entries(patientRecords)) {
                        // Sort records by date to find latest
                        const sortedRecords = records
                            .filter(r => r.resultDate && !isNaN(r.resultDate.getTime()))
                            .sort((a, b) => b.resultDate - a.resultDate);
                        
                        let firstDMDate = null;
                        let latestResult = null;
                        const age = records[0]?.age || 0; // Get age from first record
                        
                        // Find latest result overall (for control status)
                        if (sortedRecords.length > 0) {
                            const latestRecord = sortedRecords[0]; // Latest by date
                            const latestResultName = (latestRecord.resultName || '').toLowerCase();
                            let latestResultType = null;
                            
                            if (latestResultName.includes('a1c')) {
                                latestResultType = 'HBA1C';
                            } else if (latestResultName.includes('fast')) {
                                latestResultType = 'FASTING';
                            }
                            
                            if (latestResultType) {
                                latestResult = { 
                                    resultType: latestResultType, 
                                    resultValue: latestRecord.resultValue 
                                };
                            }
                        }
                        
                        // Find first DM result date
                        for (const record of sortedRecords) {
                            const resultName = (record.resultName || '').toLowerCase();
                            const resultValue = record.resultValue;
                            
                            // Check if meets DM criteria
                            let meetsDM = false;
                            if (resultName.includes('a1c') && resultValue >= DM_THRESHOLDS.HBA1C) {
                                meetsDM = true;
                            } else if (resultName.includes('fast') && resultValue >= DM_THRESHOLDS.FASTING) {
                                meetsDM = true;
                            }
                            
                            if (meetsDM && age > 34) {
                                if (!firstDMDate || record.resultDate < firstDMDate) {
                                    firstDMDate = record.resultDate;
                                }
                            }
                        }
                        
                        if (firstDMDate && firstDMDate >= DM_FIRST_RESULT_CUTOFF && latestResult) {
                            dmPatients[patientId] = { firstDMDate, latestResult, age };
                        }
                    }
                    
                    // Count controlled and uncontrolled by zone
                    let controlledCount = 0;
                    let uncontrolledCount = 0;
                    const zoneControlled = {}; // zone -> count
                    const zoneUncontrolled = {}; // zone -> count
                    const zoneOrgCounts = {}; // zone -> {org -> {controlled: count, uncontrolled: count}}
                    
                    // Reset global DM raw array
                    globalDmPatientsRaw = [];
                    
                    for (const [patientId, patientData] of Object.entries(dmPatients)) {
                        if (!patientData.latestResult) continue;
                        
                        const { resultType, resultValue } = patientData.latestResult;
                        const controlLimit = CONTROL_MAX[resultType];
                        
                        // Get zone for this patient
                        const org = patientOrganizations[patientId] || '';
                        const zone = inferZone(org);
                        
                        // Push enriched DM record for export
                        globalDmPatientsRaw.push({
                            patientId,
                            zone,
                            organization: org,
                            age: patientData.age || null,
                            firstDMDate: patientData.firstDMDate,
                            resultType,
                            resultValue,
                            isControlled: controlLimit ? resultValue <= controlLimit : null
                        });
                        
                        if (!zoneControlled[zone]) zoneControlled[zone] = 0;
                        if (!zoneUncontrolled[zone]) zoneUncontrolled[zone] = 0;
                        if (!zoneOrgCounts[zone]) zoneOrgCounts[zone] = {};
                        
                        // Count organizations by zone with controlled/uncontrolled breakdown
                        if (org) {
                            if (!zoneOrgCounts[zone][org]) {
                                zoneOrgCounts[zone][org] = { controlled: 0, uncontrolled: 0 };
                            }
                        }
                        
                        const isControlled = controlLimit && resultValue <= controlLimit;
                        
                        if (isControlled) {
                            controlledCount++;
                            zoneControlled[zone]++;
                            if (org) zoneOrgCounts[zone][org].controlled++;
                        } else {
                            uncontrolledCount++;
                            zoneUncontrolled[zone]++;
                            if (org) zoneOrgCounts[zone][org].uncontrolled++;
                        }
                    }
                    
                    const dmPatientCount = Object.keys(dmPatients).length;
                    
                    // Calculate Pre-DM patients (same logic as Python code)
                    const dmPatientIds = new Set(Object.keys(dmPatients));
                    const predmPatients = {}; // patient_id -> {firstPredmDate, lastVisitDate}
                    const IMPROVEMENT_CUTOFF = new Date("2025-06-01");
                    const today = new Date();
                    const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                    
                    for (const [patientId, records] of Object.entries(patientRecords)) {
                        // Skip if already DM
                        if (dmPatientIds.has(patientId)) continue;
                        
                        const age = records[0]?.age || 0;
                        if (age <= 34) continue;
                        
                        // Sort records by date
                        const sortedRecords = records
                            .filter(r => r.resultDate && !isNaN(r.resultDate.getTime()))
                            .sort((a, b) => b.resultDate - a.resultDate);
                        
                        let firstPredmDate = null;
                        let lastVisitDate = null;
                        let hasNormalAfterCutoff = false;
                        let hasPostCutoffVisit = false;
                        
                        // First pass: find first pre-DM date
                        for (const record of sortedRecords) {
                            if (!record.resultDate || isNaN(record.resultDate.getTime())) continue;
                            if (record.resultDate < PRE_DM_DATE_CUTOFF) continue;
                            
                            const resultName = (record.resultName || '').toLowerCase();
                            const resultValue = record.resultValue;
                            
                            // Check if meets Pre-DM criteria
                            let meetsPreDM = false;
                            if (resultName.includes('a1c')) {
                                const [low, high] = PRE_DM_RANGES.HBA1C;
                                if (resultValue >= low && resultValue <= high) {
                                    meetsPreDM = true;
                                }
                            } else if (resultName.includes('fast')) {
                                const [low, high] = PRE_DM_RANGES.FASTING;
                                if (resultValue >= low && resultValue <= high) {
                                    meetsPreDM = true;
                                }
                            }
                            
                            if (meetsPreDM) {
                                if (!firstPredmDate || record.resultDate < firstPredmDate) {
                                    firstPredmDate = record.resultDate;
                                }
                            }
                        }
                        
                        // Second pass: check for improvement and track visits
                        // Improvement is based on the LAST visit on/after IMPROVEMENT_CUTOFF
                        if (firstPredmDate) {
                            let lastVisitAfterCutoff = null;
                            
                            for (const record of sortedRecords) {
                                if (!record.resultDate || isNaN(record.resultDate.getTime())) continue;
                                
                                // Track last overall visit date
                                if (!lastVisitDate || record.resultDate > lastVisitDate) {
                                    lastVisitDate = record.resultDate;
                                }
                                
                                // Track the latest visit on/after IMPROVEMENT_CUTOFF
                                if (record.resultDate >= IMPROVEMENT_CUTOFF) {
                                    hasPostCutoffVisit = true;
                                    if (!lastVisitAfterCutoff || record.resultDate > lastVisitAfterCutoff.resultDate) {
                                        lastVisitAfterCutoff = record;
                                    }
                                }
                            }
                            
                            if (lastVisitAfterCutoff) {
                                const resultName = (lastVisitAfterCutoff.resultName || '').toLowerCase();
                                const resultValue = lastVisitAfterCutoff.resultValue;
                                    
                                    if (resultName.includes('a1c')) {
                                        const [low] = PRE_DM_RANGES.HBA1C;
                                        if (resultValue < low) {
                                            hasNormalAfterCutoff = true;
                                        }
                                    } else if (resultName.includes('fast')) {
                                        const [low] = PRE_DM_RANGES.FASTING;
                                        if (resultValue < low) {
                                            hasNormalAfterCutoff = true;
                                    }
                                }
                            }
                            
                            predmPatients[patientId] = { 
                                firstPredmDate, 
                                lastVisitDate,
                                hasNormalAfterCutoff,
                                hasPostCutoffVisit
                            };
                        }
                    }
                    
                    // Count improved and need follow-up (with zone breakdown)
                    let improvedCount = 0;
                    let needFollowupCount = 0;
                    const zonePredmImproved = {};
                    const zonePredmNeedFollowup = {};
                    const zonePredmOrgCounts = {}; // zone -> {org -> {improved: count, needFollowup: count}}
                    
                    for (const [patientId, patientData] of Object.entries(predmPatients)) {
                        const org = patientOrganizations[patientId] || '';
                        const zone = inferZone(org);
                        if (zonePredmImproved[zone] === undefined) {
                            zonePredmImproved[zone] = 0;
                            zonePredmNeedFollowup[zone] = 0;
                        }
                        if (!zonePredmOrgCounts[zone]) {
                            zonePredmOrgCounts[zone] = {};
                        }
                        
                        // Count organizations by zone with improved/needFollowup breakdown
                        if (org) {
                            if (!zonePredmOrgCounts[zone][org]) {
                                zonePredmOrgCounts[zone][org] = { improved: 0, needFollowup: 0 };
                            }
                        }
                        
                        const isImproved = patientData.hasNormalAfterCutoff && patientData.hasPostCutoffVisit;
                        let needsFollowup = !patientData.lastVisitDate || patientData.lastVisitDate < threeMonthsAgo;
                        
                        // Improved patients should NOT be counted as needing follow-up
                        if (isImproved) {
                            needsFollowup = false;
                        }
                        
                        if (isImproved) {
                            improvedCount++;
                            zonePredmImproved[zone]++;
                            if (org) zonePredmOrgCounts[zone][org].improved++;
                        }
                        
                        if (needsFollowup) {
                            needFollowupCount++;
                            zonePredmNeedFollowup[zone]++;
                            if (org) zonePredmOrgCounts[zone][org].needFollowup++;
                        }
                    }
                    
                    const predmPatientCount = Object.keys(predmPatients).length;
                    
                    // Track first-time screenings by zone and organization (age > 34)
                    const zoneScreened = {}; // zone -> Set of patient IDs
                    const zoneOrgScreened = {}; // zone -> {org -> Set of patient IDs}
                    const firstScreeningInfo = {}; // patientId -> {date, zone, organization}
                    const PROGRAM_START_DATE = new Date('2025-01-01');
                    PROGRAM_START_DATE.setHours(0, 0, 0, 0);
                    const SCREENING_SINCE_2024 = new Date('2024-10-01');
                    SCREENING_SINCE_2024.setHours(0, 0, 0, 0);
                    const screenedSince2024Set = new Set();
                    
                    for (const [patientId, records] of Object.entries(patientRecords)) {
                        const age = records[0]?.age || 0;
                        if (age <= 34) continue;
                        
                        const sortedRecords = records
                            .filter(r => r.resultDate && !isNaN(r.resultDate.getTime()))
                            .sort((a, b) => a.resultDate - b.resultDate);
                        
                        if (sortedRecords.length === 0) continue;
                        
                        const firstAfter2024 = sortedRecords.find(r => r.resultDate >= SCREENING_SINCE_2024);
                        if (firstAfter2024) {
                            screenedSince2024Set.add(patientId);
                        }
                        
                        const firstAfter2025 = sortedRecords.find(r => r.resultDate >= PROGRAM_START_DATE);
                        if (!firstAfter2025) continue;
                        
                        const org = patientOrganizations[patientId] || '';
                        const zone = inferZone(org);
                        
                        firstScreeningInfo[patientId] = {
                            date: firstAfter2025.resultDate,
                            zone,
                            organization: org
                        };
                        
                        if (!zoneScreened[zone]) zoneScreened[zone] = new Set();
                        zoneScreened[zone].add(patientId);
                        
                        if (org) {
                            if (!zoneOrgScreened[zone]) zoneOrgScreened[zone] = {};
                            if (!zoneOrgScreened[zone][org]) zoneOrgScreened[zone][org] = new Set();
                            zoneOrgScreened[zone][org].add(patientId);
                        }
                    }
                    
                    // Calculate total target (sum of all zone targets derived from PHC table)
                    const totalTarget = Object.values(TOTAL_CUMULATIVE_TARGETS).reduce((sum, target) => sum + target, 0);
                    
                    // Total screened (first-time screenings per patient after program start)
                    const screenedEntries = Object.values(firstScreeningInfo);
                    const screenedCount = screenedEntries.length;
                    const screenedFrom20241001Count = screenedSince2024Set.size;
                    const screenedFrom20241001Pct = (totalTarget && totalTarget > 0) ? ((screenedFrom20241001Count / totalTarget) * 100).toFixed(1) : '0.0';
                    
                    // Remaining to reach target
                    const remainingToTarget = Math.max(0, totalTarget - screenedCount);
                    const targetProgress = totalTarget > 0 ? ((screenedCount / totalTarget) * 100).toFixed(1) : 0;
                    
                    // Count unique zones
                    const uniqueZones = new Set(Object.values(ORG_ZONE_MAP));
                    const zoneCount = uniqueZones.size;
                    
                    // Create stats cards
                    createStatsCards(
                        dmPatientCount,
                        controlledCount,
                        uncontrolledCount,
                        predmPatientCount,
                        improvedCount,
                        needFollowupCount,
                        zoneControlled,
                        zoneUncontrolled,
                        zoneOrgCounts,
                        zonePredmOrgCounts,
                        zonePredmImproved,
                        zonePredmNeedFollowup,
                        totalTarget,
                        screenedCount,
                        remainingToTarget,
                        targetProgress,
                        zoneScreened,
                        zoneOrgScreened,
                        screenedFrom20241001Count,
                        screenedFrom20241001Pct
                    );
                    
                    // Show dashboard
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    document.getElementById('dashboard').style.display = 'block';
                    const lastUpdateDate = latestResultDate ? latestResultDate.toLocaleString() : new Date().toLocaleString();
                    const lastUpdate = document.getElementById('lastUpdate');
                    if (lastUpdate) {
                        lastUpdate.textContent = lastUpdateDate;
                    }
                    // Update sidebar last update
                    const sidebarUpdate = document.getElementById('sidebarLastUpdate');
                    if (sidebarUpdate) {
                        sidebarUpdate.textContent = `Last updated: ${lastUpdateDate}`;
                    }
                    
                    // Building visualization removed
                },
                error: function(error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Error parsing CSV: ' + error.message;
                }
            });
        }

        function createStatsCards(dmPatientCount, controlledCount, uncontrolledCount, predmPatientCount, improvedCount, needFollowupCount, zoneControlled, zoneUncontrolled, zoneOrgCounts, zonePredmOrgCounts, zonePredmImproved, zonePredmNeedFollowup, totalTarget, screenedCount, remainingToTarget, targetProgress, zoneScreened, zoneOrgScreened, screenedFrom20241001Count, screenedFrom20241001Pct) {
            const mainCardsContainer = document.getElementById('mainCardsContainer');
            const controlledPct = dmPatientCount > 0 ? ((controlledCount / dmPatientCount) * 100).toFixed(1) : 0;
            const uncontrolledPct = dmPatientCount > 0 ? ((uncontrolledCount / dmPatientCount) * 100).toFixed(1) : 0;
            const needFollowupPct = predmPatientCount > 0 ? ((needFollowupCount / predmPatientCount) * 100).toFixed(1) : 0;
            const improvedPct = predmPatientCount > 0 ? ((improvedCount / predmPatientCount) * 100).toFixed(1) : 0;
            const screenedPct = totalTarget > 0 ? ((screenedCount / totalTarget) * 100).toFixed(1) : 0;
            const remainingPct = totalTarget > 0 ? ((remainingToTarget / totalTarget) * 100).toFixed(1) : 0;
            
            // Goal alignment metrics
            const dmControlledActualPct = dmPatientCount > 0 ? (controlledCount / dmPatientCount) * 100 : 0;
            const dmControlledGoalPct = 90;
            const dmControlledProgressPct = dmControlledGoalPct > 0 ? Math.min(100, (dmControlledActualPct / dmControlledGoalPct) * 100) : 0;
            
            const predmImprovedActualPct = predmPatientCount > 0 ? (improvedCount / predmPatientCount) * 100 : 0;
            const predmImprovedGoalPct = 50;
            const predmImprovedProgressPct = predmImprovedGoalPct > 0 ? Math.min(100, (predmImprovedActualPct / predmImprovedGoalPct) * 100) : 0;
            
            const screeningActualPct = totalTarget > 0 ? (screenedCount / totalTarget) * 100 : 0;
            const screeningGoalPct = 70;
            const screeningProgressPct = screeningGoalPct > 0 ? Math.min(100, (screeningActualPct / screeningGoalPct) * 100) : 0;
            
            // Overall goal progress: average of the three process percentages
            // Overall Process % = (DM process % + Pre-DM process % + Screening process %) / 3
            const overallProgressPct = (dmControlledProgressPct + predmImprovedProgressPct + screeningProgressPct) / 3;
            
            // Populate Goal Alignment Dashboard in Placeholder 2 (Pre-DM Patients section)
            const goalSection = document.getElementById('pre-dm-patients-section');
            if (goalSection) {
                // Build per-zone metrics including overall progress, then sort by overall (high → low)
                const zoneMetrics = Object.keys(TOTAL_CUMULATIVE_TARGETS).map(zone => {
                    // DM control by zone
                    const dmZoneControlled = zoneControlled[zone] || 0;
                    const dmZoneUncontrolled = zoneUncontrolled[zone] || 0;
                    const dmZoneTotal = dmZoneControlled + dmZoneUncontrolled;
                    const dmZoneControlledPct = dmZoneTotal > 0 ? (dmZoneControlled / dmZoneTotal) * 100 : 0;
                    const dmZoneControlledProgress = dmControlledGoalPct > 0 ? Math.min(100, (dmZoneControlledPct / dmControlledGoalPct) * 100) : 0;
                    
                    // Pre-DM improvement by zone
                    const predmZoneImproved = (zonePredmImproved && zonePredmImproved[zone]) || 0;
                    const predmZoneNeedFollowup = (zonePredmNeedFollowup && zonePredmNeedFollowup[zone]) || 0;
                    const predmZoneTotal = predmZoneImproved + predmZoneNeedFollowup;
                    const predmZoneImprovedPct = predmZoneTotal > 0 ? (predmZoneImproved / predmZoneTotal) * 100 : 0;
                    const predmZoneProgress = predmImprovedGoalPct > 0 ? Math.min(100, (predmZoneImprovedPct / predmImprovedGoalPct) * 100) : 0;
                    
                    // Screening coverage by zone (using targets derived from PHC table)
                    const zoneTarget = TOTAL_CUMULATIVE_TARGETS[zone] || 0;
                    const zoneScreenedSet = zoneScreened[zone];
                    const zoneScreenedCount = zoneScreenedSet ? zoneScreenedSet.size : 0;
                    const zoneScreenedPct = zoneTarget > 0 ? (zoneScreenedCount / zoneTarget) * 100 : 0;
                    const zoneScreenedProgress = screeningGoalPct > 0 ? Math.min(100, (zoneScreenedPct / screeningGoalPct) * 100) : 0;
                    
                    // Overall progress for this zone against all three goals combined
                    // Overall Process % = (DM process % + Pre-DM process % + Screening process %) / 3
                    const zoneOverallPct = (dmZoneControlledProgress + predmZoneProgress + zoneScreenedProgress) / 3;
                    
                    return {
                        zone,
                        dmZoneControlled,
                        dmZoneTotal,
                        dmZoneControlledProgress,
                        predmZoneImproved,
                        predmZoneTotal,
                        predmZoneProgress,
                        zoneScreenedCount,
                        zoneTarget,
                        zoneScreenedProgress,
                        zoneOverallPct
                    };
                });
                
                // Sort zones by overall progress descending
                zoneMetrics.sort((a, b) => b.zoneOverallPct - a.zoneOverallPct);
                
                const zoneRows = zoneMetrics.map(m => {
                    const {
                        zone,
                        dmZoneControlled,
                        dmZoneTotal,
                        dmZoneControlledProgress,
                        predmZoneImproved,
                        predmZoneTotal,
                        predmZoneProgress,
                        zoneScreenedCount,
                        zoneTarget,
                        zoneScreenedProgress,
                        zoneOverallPct
                    } = m;
                    
                    return `
                        <tr class="zone-summary-row" data-zone="${zone}" data-cluster="NHC" style="display: none;">
                            <td style="padding: 10px; text-align: center; color: rgba(255,255,255,0.9); border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.9em;">
                                NHC
                            </td>
                            <td style="padding: 10px; text-align: center; color: rgba(255,255,255,0.9); border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.9em; cursor: pointer;">
                                <span style="text-decoration: underline; text-underline-offset: 2px;">${zone}</span>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    <span style="color: rgba(255,255,255,0.9); font-size: 0.85em; font-weight: 600;">
                                        ${zoneOverallPct.toFixed(1)}% of combined goals
                                    </span>
                                    <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                        <div style="width: ${zoneOverallPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(0,200,255,0.9), rgba(0,230,118,0.9));"></div>
                                </div>
                            </div>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: rgba(255,255,255,0.8); font-size: 0.8em; min-width: 80px;">
                                        ${dmZoneControlled} / ${dmZoneTotal} pts
                                    </span>
                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                        <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                            <div style="width: ${dmZoneControlledProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(70,130,180,0.8), rgba(0,200,255,0.9));"></div>
                                                    </div>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                            ${dmZoneControlledProgress.toFixed(1)}%
                                        </span>
                                </div>
                            </div>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: rgba(255,255,255,0.8); font-size: 0.8em; min-width: 80px;">
                                        ${predmZoneImproved} / ${predmZoneTotal} pts
                                    </span>
                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                        <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                            <div style="width: ${predmZoneProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(76,175,80,0.8), rgba(0,230,118,0.9));"></div>
                                            </div>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                            ${predmZoneProgress.toFixed(1)}%
                                        </span>
                                                        </div>
                                                    </div>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: rgba(255,255,255,0.8); font-size: 0.8em; min-width: 80px;">
                                        ${zoneScreenedCount} / ${zoneTarget} screened
                                    </span>
                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                        <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                            <div style="width: ${zoneScreenedProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(255,193,7,0.9), rgba(255,235,59,0.9));"></div>
                                </div>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                            ${zoneScreenedProgress.toFixed(1)}%
                                        </span>
                            </div>
                        </div>
                            </td>
                        </tr>
                        <tr class="zone-detail-row" data-zone-detail="${zone}" data-cluster="NHC" style="display: none; background: rgba(0,0,0,0.25);">
                            <td colspan="6" style="padding: 8px 12px;">
                                <div class="zone-org-container" id="zone-org-${zone}" style="margin-top: 4px;"></div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                goalSection.innerHTML = `
                <div class="placeholder-sheet" style="margin-top: 0;">
                    <h2>Goal Tracking</h2>
                    <!-- Desktop table view -->
                    <div class="goals-desktop-table" style="overflow-x: auto;">
                        <table id="zone-goal-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.08);">
                                        <th style="padding: 10px; text-align: center; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Cluster</th>
                                        <th style="padding: 10px; text-align: center; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Zone</th>
                                        <th style="padding: 10px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Overall Progress</th>
                                        <th style="padding: 10px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            DM Controlled
                                            <span style="cursor: pointer; font-size: 0.8em; margin-left: 4px;"
                                                  onclick="showProcessInfo('Process % = (Controlled DM patients ÷ (Total DM patients × 90%)) × 100')">
                                                (i)
                                            </span>
                                        </th>
                                        <th style="padding: 10px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            Pre-DM Improved
                                            <span style="cursor: pointer; font-size: 0.8em; margin-left: 4px;"
                                                  onclick="showProcessInfo('Process % = (Pre-DM back to normal ÷ (Total Pre-DM × 50%)) × 100')">
                                                (i)
                                            </span>
                                        </th>
                                        <th style="padding: 10px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            Screening Coverage
                                            <span style="cursor: pointer; font-size: 0.8em; margin-left: 4px;"
                                                  onclick="showProcessInfo('Process % = (Screened ÷ (Total target × 70%)) × 100')">
                                                (i)
                                            </span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Cluster summary row -->
                                    <tr class="cluster-summary-row" data-cluster="NHC">
                                        <td style="padding: 10px; text-align: center; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15); font-weight: 600; cursor: pointer;">
                                            NHC
                                        </td>
                                        <td style="padding: 10px; text-align: center; color: rgba(255,255,255,0.85); border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            All Zones
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="color: rgba(255,255,255,0.95); font-size: 0.9em; font-weight: 600;">
                                                    ${overallProgressPct.toFixed(1)}% of combined goals
                                                </span>
                                                <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 10px;">
                                                    <div style="width: ${overallProgressPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(0,200,255,0.9), rgba(0,230,118,0.9));"></div>
                                        </div>
                                        </div>
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="color: rgba(255,255,255,0.85); font-size: 0.85em; min-width: 80px;">
                                                    ${controlledCount} / ${dmPatientCount} pts
                                                </span>
                                                <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                    <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                                        <div style="width: ${dmControlledProgressPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(70,130,180,0.8), rgba(0,200,255,0.9));"></div>
                                    </div>
                                                    <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                                        ${dmControlledProgressPct.toFixed(1)}%
                                                    </span>
                                </div>
                            </div>
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="color: rgba(255,255,255,0.85); font-size: 0.85em; min-width: 80px;">
                                                    ${improvedCount} / ${predmPatientCount} pts
                                                </span>
                                                <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                    <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                                        <div style="width: ${predmImprovedProgressPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(76,175,80,0.8), rgba(0,230,118,0.9));"></div>
                        </div>
                                                    <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                                        ${predmImprovedProgressPct.toFixed(1)}%
                                                    </span>
                            </div>
                        </div>
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.15);">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="color: rgba(255,255,255,0.85); font-size: 0.85em; min-width: 80px;">
                                                    ${screenedCount} / ${totalTarget} screened
                                                </span>
                                                <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                    <div style="background: rgba(255,255,255,0.12); border-radius: 999px; overflow: hidden; height: 8px;">
                                                        <div style="width: ${screeningProgressPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(255,193,7,0.9), rgba(255,235,59,0.9));"></div>
                            </div>
                                                    <span style="color: rgba(255,255,255,0.7); font-size: 0.7em;">
                                                        ${screeningProgressPct.toFixed(1)}%
                                                    </span>
                            </div>
                        </div>
                                        </td>
                                    </tr>
                                    ${zoneRows}
                                </tbody>
                            </table>
                    </div>
                    <!-- Mobile goal metric toggle -->
                    <div class="goals-mobile-toggle">
                        <button class="goals-toggle-btn active" data-metric="overall">Overall</button>
                        <button class="goals-toggle-btn" data-metric="dm">DM</button>
                        <button class="goals-toggle-btn" data-metric="predm">Pre‑DM</button>
                        <button class="goals-toggle-btn" data-metric="screen">Screening</button>
                </div>
                    <!-- Mobile stacked cards -->
                    <div id="goals-mobile-cards" class="goals-mobile-cards"></div>
                                </div>
                `;
                
                // Setup zone row expand/collapse to show organization-level progress and clustering
                setupZoneGoalExpansion(zoneOrgCounts, zonePredmOrgCounts, zoneOrgScreened, TOTAL_CUMULATIVE_TARGETS);
                // Setup mobile stacked cards + toggle for Goals section
                setupGoalsMobileToggle(
                    zoneMetrics,
                    zoneOrgCounts,
                    zonePredmOrgCounts,
                    zoneOrgScreened,
                    {
                        overall: overallProgressPct,
                        dm: dmControlledProgressPct,
                        predm: predmImprovedProgressPct,
                        screen: screeningProgressPct,
                        screenedCount: screenedCount,
                        totalTarget: totalTarget,
                        controlledCount: controlledCount,
                        dmPatientCount: dmPatientCount,
                        improvedCount: improvedCount,
                        predmPatientCount: predmPatientCount
                    }
                );
            }
            
            mainCardsContainer.innerHTML = `
            <div class="main-cards-container">
                <div class="stat-card active" data-card-index="0" style="border-radius: 16px; padding: 16px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2); color: white; overflow: hidden; position: relative;">
                    <div class="goal-mobile-card-header" style="margin-bottom: 12px;">
                        <div class="goal-mobile-title" style="font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.98);">Total DM</div>
                                </div>
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: rgba(255, 255, 255, 0.98); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(dmPatientCount || 0).toLocaleString()}</div>
                                                    </div>
                    <div class="sub-sub-cards-container" style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <div class="sub-sub-card success-card" style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">
                                                <div class="sub-sub-card-inner">
                                <div class="sub-sub-card-front" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.12) 100%); border: 1px solid rgba(59, 130, 246, 0.25); border-radius: 10px; padding: 10px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    <div style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">
                                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; color: rgba(255, 255, 255, 0.95); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(controlledCount || 0).toLocaleString()}</div>
                                        <div style="font-size: 0.65rem; color: rgba(147, 197, 253, 0.9); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">Controlled (${controlledPct}%)</div>
                            </div>
                                                    </div>
                                <div class="sub-sub-card-back" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.12) 100%); border: 1px solid rgba(59, 130, 246, 0.25); border-radius: 10px; padding: 10px; text-align: center; font-size: 0.7rem; color: rgba(255, 255, 255, 0.85); line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    HbA1c ≤8.0%<br>or Fasting ≤9.0<br>(Latest result)
                                </div>
                            </div>
                                            </div>
                        <div class="sub-sub-card alert-card" style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">
                                                <div class="sub-sub-card-inner">
                                <div class="sub-sub-card-front" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.12) 100%); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 10px; padding: 10px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    <div style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">
                                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; color: rgba(255, 255, 255, 0.95); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(uncontrolledCount || 0).toLocaleString()}</div>
                                        <div style="font-size: 0.65rem; color: rgba(252, 165, 165, 0.9); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">Uncontrolled (${uncontrolledPct}%)</div>
                                                        </div>
                                                    </div>
                                <div class="sub-sub-card-back" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.12) 100%); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 10px; padding: 10px; text-align: center; font-size: 0.7rem; color: rgba(255, 255, 255, 0.85); line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    HbA1c >8.0%<br>or Fasting >9.0<br>(Latest result)
                                </div>
                            </div>
                        </div>
                                        </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.7rem; line-height: 1.5; color: rgba(255, 255, 255, 0.75); text-align: center; word-wrap: break-word; overflow-wrap: break-word;">
                        <strong style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 6px;">Criteria:</strong>
                        <div style="text-align: left; padding-left: 16px;">
                                            HbA1c ≥6.5% or Fasting ≥7.0<br>
                                            First after 2025-06-01<br>
                                            Age > 34
                                        </div>
                                    </div>
                                </div>
                <div class="stat-card" data-card-index="1" style="border-radius: 16px; padding: 16px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2); color: white; overflow: hidden; position: relative;">
                    <div class="goal-mobile-card-header" style="margin-bottom: 12px;">
                        <div class="goal-mobile-title" style="font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.98);">Total Pre-DM</div>
                            </div>
                    <div style="text-align: center; margin-bottom: 12px;">
                        <div style="font-size: 1.5em; font-weight: 700; color: rgba(255, 255, 255, 0.98); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(predmPatientCount || 0).toLocaleString()}</div>
                        </div>
                    <div class="sub-sub-cards-container" style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <div class="sub-sub-card success-card" style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">
                                                <div class="sub-sub-card-inner">
                                                    <div class="sub-sub-card-front" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.12) 100%); border: 1px solid rgba(34, 197, 94, 0.25); border-radius: 10px; padding: 10px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    <div style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">
                                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; color: rgba(255, 255, 255, 0.95); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(improvedCount || 0).toLocaleString()}</div>
                                        <div style="font-size: 0.65rem; color: rgba(134, 239, 172, 0.9); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">Improved (${improvedPct}%)</div>
                            </div>
                                                    </div>
                                <div class="sub-sub-card-back" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.12) 100%); border: 1px solid rgba(34, 197, 94, 0.25); border-radius: 10px; padding: 10px; text-align: center; font-size: 0.7rem; color: rgba(255, 255, 255, 0.85); line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    Normal result<br>after 2025-06-01<br>(HbA1c <5.7%<br>or Fasting <5.6)
                                </div>
                            </div>
                                            </div>
                        <div class="sub-sub-card alert-card" style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">
                                                <div class="sub-sub-card-inner">
                                                    <div class="sub-sub-card-front" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.12) 100%); border: 1px solid rgba(251, 191, 36, 0.25); border-radius: 10px; padding: 10px; text-align: center; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    <div style="word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">
                                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; color: rgba(255, 255, 255, 0.95); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${(needFollowupCount || 0).toLocaleString()}</div>
                                        <div style="font-size: 0.65rem; color: rgba(253, 224, 71, 0.9); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">Need Follow-up (${needFollowupPct}%)</div>
                                                        </div>
                                                    </div>
                                <div class="sub-sub-card-back" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.12) 100%); border: 1px solid rgba(251, 191, 36, 0.25); border-radius: 10px; padding: 10px; text-align: center; font-size: 0.7rem; color: rgba(255, 255, 255, 0.85); line-height: 1.4; word-wrap: break-word; overflow-wrap: break-word; overflow: hidden;">
                                    No visit within<br>last 3 months<br>(or no visit<br>recorded)
                                </div>
                            </div>
                        </div>
                                        </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.7rem; line-height: 1.5; color: rgba(255, 255, 255, 0.75); text-align: center; word-wrap: break-word; overflow-wrap: break-word;">
                        <strong style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 6px;">Criteria:</strong>
                        <div style="text-align: left; padding-left: 16px;">
                                            HbA1c: 5.7-6.4% or Fasting: 5.6-6.9<br>
                                            Result ≥ 2025-01-01<br>
                                            Age > 34<br>
                                            Excludes DM
                                        </div>
                                    </div>
                                </div>
                <div class="stat-card" data-card-index="2" style="border-radius: 16px; padding: 16px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2); color: white; overflow: hidden; position: relative;">
                    <div class="goal-mobile-card-header" style="margin-bottom: 12px;">
                        <div class="goal-mobile-title" style="font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.98);">Screened</div>
                            </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; margin-bottom: 8px; color: rgba(255, 255, 255, 0.98);">${(screenedCount || 0).toLocaleString()}</div>
                            <div style="font-size: 0.75rem; opacity: 0.85; color: rgba(255, 255, 255, 0.8); margin-bottom: 12px;">Screened (${screenedPct}%)</div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.7rem; line-height: 1.5; color: rgba(255, 255, 255, 0.75);">
                            <strong style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 6px;">Criteria:</strong>
                            <div style="text-align: left; padding-left: 16px;">
                                • Age above 34<br>
                                • Not pregnant
                            </div>
                        </div>
                            </div>
                            </div>
                <div class="stat-card" data-card-index="3" style="border-radius: 16px; padding: 16px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2); color: white; overflow: hidden; position: relative;">
                    <div class="goal-mobile-card-header" style="margin-bottom: 12px;">
                        <div class="goal-mobile-title" style="font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.98);">Screened (from 2024-10-01)</div>
                        </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; margin-bottom: 8px; color: rgba(255, 255, 255, 0.98);">${(screenedFrom20241001Count || 0).toLocaleString()}</div>
                            <div style="font-size: 0.75rem; opacity: 0.85; color: rgba(255, 255, 255, 0.8); margin-bottom: 12px;">Screened (${screenedFrom20241001Pct || '0.0'}%)</div>
                    </div>
                        <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1); font-size: 0.7rem; line-height: 1.5; color: rgba(255, 255, 255, 0.75);">
                            <strong style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 6px;">Criteria:</strong>
                            <div style="text-align: left; padding-left: 16px;">
                                • Age above 34<br>
                                • Not pregnant
                </div>
                                        </div>
                                                        </div>
                                                    </div>
                            </div>
            <div class="dashboard-pagination">
                <div class="dashboard-dot active" data-card-index="0"></div>
                <div class="dashboard-dot" data-card-index="1"></div>
                <div class="dashboard-dot" data-card-index="2"></div>
                <div class="dashboard-dot" data-card-index="3"></div>
                        </div>
            `;
            
            // Setup click handlers for stat sub-cards
            setupStatSubCardHandlers();
            
            // Setup dashboard swipe and pagination dots
            setupDashboardSwipe();
            
            // Create zone list
            createZoneList(TOTAL_CUMULATIVE_TARGETS, zoneControlled, zoneUncontrolled, zonePredmImproved, zonePredmNeedFollowup, zoneScreened);
            
            // Setup sidebar navigation
            setupSidebarNavigation();
            
            // Setup daily summary button
            setupDailySummary();
        }
        
        // Function to create expandable zone list
        function createZoneList(totalTargets, zoneControlled, zoneUncontrolled, zonePredmImproved, zonePredmNeedFollowup, zoneScreened) {
            const zoneListContainer = document.getElementById('zoneListContainer');
            if (!zoneListContainer) return;
            
            // Get all zones and sort them
            const allZones = Object.keys(totalTargets).sort();
            
            const zoneItems = allZones.map(zone => {
                const target = totalTargets[zone] || 0;
                const dmControlled = zoneControlled[zone] || 0;
                const dmUncontrolled = zoneUncontrolled[zone] || 0;
                const dmTotal = dmControlled + dmUncontrolled;
                const predmImproved = zonePredmImproved[zone] || 0;
                const predmNeedFollowup = zonePredmNeedFollowup[zone] || 0;
                const predmTotal = predmImproved + predmNeedFollowup;
                const screened = zoneScreened[zone] ? zoneScreened[zone].size : 0;
                const screenedPct = target > 0 ? ((screened / target) * 100).toFixed(1) : '0.0';
                const controlledPct = dmTotal > 0 ? ((dmControlled / dmTotal) * 100).toFixed(1) : '0.0';
                const improvedPct = predmTotal > 0 ? ((predmImproved / predmTotal) * 100).toFixed(1) : '0.0';
                
                return `
                    <div class="zone-item" data-zone="${zone}">
                        <div class="zone-header">
                                                        <div>
                                <div class="zone-name">${zone}</div>
                                <div class="zone-target">Target: ${target.toLocaleString()}</div>
                        </div>
                            <div class="zone-expand-icon">▼</div>
                                                    </div>
                        <div class="zone-details">
                            <div class="zone-details-grid">
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Total DM</div>
                                    <div class="zone-detail-value">${dmTotal.toLocaleString()}</div>
                            </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Controlled</div>
                                    <div class="zone-detail-value">${dmControlled.toLocaleString()} (${controlledPct}%)</div>
                        </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Uncontrolled</div>
                                    <div class="zone-detail-value">${dmUncontrolled.toLocaleString()}</div>
                    </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Total Pre-DM</div>
                                    <div class="zone-detail-value">${predmTotal.toLocaleString()}</div>
                                        </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Improved</div>
                                    <div class="zone-detail-value">${predmImproved.toLocaleString()} (${improvedPct}%)</div>
                                        </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Need Follow-up</div>
                                    <div class="zone-detail-value">${predmNeedFollowup.toLocaleString()}</div>
                                    </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Screened</div>
                                    <div class="zone-detail-value">${screened.toLocaleString()} (${screenedPct}%)</div>
                                </div>
                                <div class="zone-detail-item">
                                    <div class="zone-detail-label">Remaining</div>
                                    <div class="zone-detail-value">${Math.max(0, target - screened).toLocaleString()}</div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            }).join('');
            
            zoneListContainer.innerHTML = `<div class="zone-list">${zoneItems}</div>`;
            
            // Setup click handlers for expand/collapse
            const zoneItemsElements = zoneListContainer.querySelectorAll('.zone-item');
            zoneItemsElements.forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('expanded');
                });
            });
        }
        
        
        // Store global data for daily summary and DM raw data export
        let globalAllPatientData = [];
        let globalHasDmIds = new Set();
        let globalOrgZoneMap = {};
        let globalZoneLookup = {};
        let globalDmPatientsRaw = []; // Array of enriched DM patient records for export
        
        // Flag to prevent multiple event listeners
        let dailySummaryListenerAdded = false;
        
        function setupDailySummary() {
            // Use event delegation on the document to handle clicks even if button is in hidden section
            if (!dailySummaryListenerAdded) {
                document.addEventListener('click', function(e) {
                    // Daily summary button
                    if (e.target && e.target.id === 'generateDailySummary') {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Generate Daily Summary button clicked!');
                        const datePicker = document.getElementById('dailyDatePicker');
                        if (!datePicker) {
                            console.error('Date picker not found');
                            alert('Error: Date picker not found. Please refresh the page.');
                            return;
                        }
                        if (!datePicker.value) {
                            alert('Please select a date first.');
                            return;
                        }
                        const selectedDate = new Date(datePicker.value);
                        if (isNaN(selectedDate.getTime())) {
                            alert('Invalid date selected.');
                            return;
                        }
                        console.log('Generating daily summary for date:', selectedDate);
                        generateLastDaySummary(selectedDate);
                    }
                    
                    // Weekly summary button
                    if (e.target && e.target.id === 'generateWeeklySummary') {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Generate Weekly Summary button clicked!');
                        const dateFrom = document.getElementById('weeklyDateFrom');
                        const dateTo = document.getElementById('weeklyDateTo');
                        if (!dateFrom || !dateTo) {
                            console.error('Date pickers not found');
                            alert('Error: Date pickers not found. Please refresh the page.');
                            return;
                        }
                        if (!dateFrom.value || !dateTo.value) {
                            alert('Please select both From and To dates.');
                            return;
                        }
                        const startDate = new Date(dateFrom.value);
                        const endDate = new Date(dateTo.value);
                        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                            alert('Invalid date selected.');
                            return;
                        }
                        if (startDate > endDate) {
                            alert('From date must be before or equal to To date.');
                            return;
                        }
                        console.log('Generating weekly summary for dates:', startDate, 'to', endDate);
                        generateWeeklySummary(startDate, endDate);
                    }
                    
                    // Toggle buttons
                    if (e.target && (e.target.id === 'toggleDaily' || e.target.id === 'toggleWeekly')) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Toggle button clicked:', e.target.id);
                        const isDaily = e.target.id === 'toggleDaily';
                        const dailyCard = document.getElementById('dailyCard');
                        const weeklyCard = document.getElementById('weeklyCard');
                        const dailyBtn = document.getElementById('toggleDaily');
                        const weeklyBtn = document.getElementById('toggleWeekly');
                        
                        if (!dailyCard || !weeklyCard || !dailyBtn || !weeklyBtn) {
                            console.error('Toggle elements not found');
                            return;
                        }
                        
                        if (isDaily) {
                            dailyCard.style.display = 'block';
                            weeklyCard.style.display = 'none';
                            dailyBtn.classList.add('active');
                            weeklyBtn.classList.remove('active');
                            console.log('Switched to Daily view');
                        } else {
                            dailyCard.style.display = 'none';
                            weeklyCard.style.display = 'block';
                            dailyBtn.classList.remove('active');
                            weeklyBtn.classList.add('active');
                            console.log('Switched to Weekly view');
                        }
                    }
                });
                dailySummaryListenerAdded = true;
                console.log('Daily/Weekly summary event listeners added');
            }
        }
        
        function generateLastDaySummary(selectedDate) {
            console.log('generateLastDaySummary called with:', selectedDate);
            console.log('globalAllPatientData length:', globalAllPatientData ? globalAllPatientData.length : 0);
            
            const tableElement = document.getElementById('dailySummaryTable');
            if (!tableElement) {
                console.error('dailySummaryTable element not found');
                return;
            }
            
            if (!globalAllPatientData || globalAllPatientData.length === 0) {
                tableElement.innerHTML = 
                    '<p style="color: rgba(255, 255, 255, 0.7);">No data available. Please wait for data to load.</p>';
                return;
            }
            
            // Convert date to date-only (no time)
            const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
            const screeningStartDate = new Date("2025-01-01");
            screeningStartDate.setHours(0, 0, 0, 0);
            
            // Check if Thursday is in the range (if selected date is Thursday, include Fri+Sat)
            let endDate = new Date(selectedDateOnly);
            if (selectedDateOnly.getDay() === 4) { // Thursday = 4
                endDate = new Date(selectedDateOnly);
                endDate.setDate(endDate.getDate() + 2); // Add 2 days to get Saturday
            }
            
            // Filter data from SCREENING_START_DATE onwards
            let filteredData = globalAllPatientData.filter(record => {
                if (!record.resultDate || isNaN(record.resultDate.getTime())) return false;
                const recordDate = new Date(record.resultDate);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate >= screeningStartDate;
            });
            
            // Exclude HAS DM patients
            filteredData = filteredData.filter(record => !globalHasDmIds.has(record.patientId));
            
            // Find patients with visits before selected date
            const patientsWithOlderVisits = new Set();
            filteredData.forEach(record => {
                if (record.resultDate) {
                    const recordDate = new Date(record.resultDate);
                    recordDate.setHours(0, 0, 0, 0);
                    if (recordDate < selectedDateOnly) {
                        patientsWithOlderVisits.add(record.patientId);
                    }
                }
            });
            
            // Filter for date range and exclude patients with older visits
            // Also filter by age > 34
            let lastDayData = filteredData.filter(record => {
                if (!record.resultDate || isNaN(record.resultDate.getTime())) return false;
                const recordDate = new Date(record.resultDate);
                recordDate.setHours(0, 0, 0, 0);
                const inDateRange = recordDate >= selectedDateOnly && recordDate <= endDate;
                const noOlderVisits = !patientsWithOlderVisits.has(record.patientId);
                const ageValid = record.age > 34;
                return inDateRange && noOlderVisits && ageValid;
            });
            
            if (lastDayData.length === 0) {
                document.getElementById('dailySummaryTable').innerHTML = 
                    '<p style="color: rgba(255, 255, 255, 0.7);">No screenings found for the selected date.</p>';
                return;
            }
            
            // Remove duplicates: if a patient has multiple tests on the same day, keep HbA1c over Fasting
            const testPriority = { 'HBA1C': 1, 'FASTING': 2, 'OTHER': 3 };
            lastDayData.sort((a, b) => {
                if (a.patientId !== b.patientId) return a.patientId.localeCompare(b.patientId);
                const priorityA = testPriority[a.resultType] || 3;
                const priorityB = testPriority[b.resultType] || 3;
                return priorityA - priorityB;
            });
            
            // Keep only first record per patient
            const seenPatients = new Set();
            lastDayData = lastDayData.filter(record => {
                if (seenPatients.has(record.patientId)) return false;
                seenPatients.add(record.patientId);
                return true;
            });
            
            // Group by zone
            const zoneData = {};
            lastDayData.forEach(record => {
                const org = record.organization || '';
                const zone = globalZoneLookup[org.toLowerCase().trim().replace(/\s+/g, ' ')] || 'Unknown';
                if (!zoneData[zone]) {
                    zoneData[zone] = [];
                }
                zoneData[zone].push(record);
            });
            
            // Build summary table
            const summaryRows = [];
            // Daily targets by zone (from Python code)
            const DAILY_TARGETS_LOCAL = {
                "KKH": 225,
                "MCH": 80,
                "BGH": 75,
                "TGH": 75,
                "HGH": 100,
                "KGH": 150,
                "SGH": 200,
                "WNH": 325,
                "NNGH": 200,
                "YGH": 75
            };
            const sortedZones = Object.keys(DAILY_TARGETS_LOCAL).sort();
            
            sortedZones.forEach(zone => {
                const count = zoneData[zone] ? zoneData[zone].length : 0;
                const target = DAILY_TARGETS_LOCAL[zone] || 0;
                const achievement = target > 0 ? (count / target) : 0;
                
                summaryRows.push({
                    zone: zone,
                    target: target,
                    count: count,
                    achievement: achievement
                });
            });
            
            // Add total row
            const totalCount = lastDayData.length;
            const totalTarget = Object.values(DAILY_TARGETS_LOCAL).reduce((sum, t) => sum + t, 0);
            const totalAchievement = totalTarget > 0 ? (totalCount / totalTarget) : 0;
            
            const totalRow = {
                zone: 'Total',
                target: totalTarget,
                count: totalCount,
                achievement: totalAchievement
            };
            
            // Sort by achievement (highest to lowest), but keep Total row separate
            summaryRows.sort((a, b) => b.achievement - a.achievement);
            
            // Add Total row at the end
            summaryRows.push(totalRow);
            
            // Function to get color based on achievement percentage
            function getAchievementColor(achievementPct) {
                if (achievementPct >= 100) {
                    return '#00BFFF'; // Bright blue
                } else if (achievementPct >= 80) {
                    return '#00FF00'; // Green
                } else if (achievementPct >= 61) {
                    return '#FFFF00'; // Yellow
                } else if (achievementPct >= 30) {
                    return '#FF0000'; // Red
                } else {
                    return '#000000'; // Black
                }
            }
            
            // Render table
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(70, 130, 180, 0.6);">
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Zone</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Target</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Count</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Achievement</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            summaryRows.forEach(row => {
                const isTotal = row.zone === 'Total';
                const rowStyle = isTotal ? 'background: rgba(70, 130, 180, 0.3); font-weight: bold;' : '';
                const achievementPct = parseFloat((row.achievement * 100).toFixed(1));
                const achievementColor = getAchievementColor(achievementPct);
                const textColor = achievementPct < 30 ? '#FFFFFF' : '#000000'; // White text for black background
                tableHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.zone}</td>
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.target.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.count.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: center; background-color: ${achievementColor}; color: ${textColor}; font-weight: bold; border-bottom: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px;">${achievementPct.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('dailySummaryTable').innerHTML = tableHTML;
        }
        
        function generateWeeklySummary(startDate, endDate) {
            console.log('generateWeeklySummary called with:', startDate, 'to', endDate);
            console.log('globalAllPatientData length:', globalAllPatientData ? globalAllPatientData.length : 0);
            
            const tableElement = document.getElementById('weeklySummaryTable');
            if (!tableElement) {
                console.error('weeklySummaryTable element not found');
                alert('Error: Table element not found. Please refresh the page.');
                return;
            }
            
            if (!globalAllPatientData || globalAllPatientData.length === 0) {
                tableElement.innerHTML = 
                    '<p style="color: rgba(255, 255, 255, 0.7);">No data available. Please wait for data to load and try again.</p>';
                return;
            }
            
            // Show loading message
            tableElement.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">Generating summary...</p>';
            
            // Convert dates to date-only (no time)
            const startDateOnly = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
            const endDateOnly = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
            const screeningStartDate = new Date("2025-01-01");
            screeningStartDate.setHours(0, 0, 0, 0);
            
            // Filter data from SCREENING_START_DATE onwards
            let filteredData = globalAllPatientData.filter(record => {
                if (!record.resultDate || isNaN(record.resultDate.getTime())) return false;
                const recordDate = new Date(record.resultDate);
                recordDate.setHours(0, 0, 0, 0);
                return recordDate >= screeningStartDate;
            });
            
            // Exclude HAS DM patients
            filteredData = filteredData.filter(record => !globalHasDmIds.has(record.patientId));
            
            // Find patients with visits before start date
            const patientsWithOlderVisits = new Set();
            filteredData.forEach(record => {
                if (record.resultDate) {
                    const recordDate = new Date(record.resultDate);
                    recordDate.setHours(0, 0, 0, 0);
                    if (recordDate < startDateOnly) {
                        patientsWithOlderVisits.add(record.patientId);
                    }
                }
            });
            
            // Filter for date range and exclude patients with older visits
            // Also filter by age > 34
            let weeklyData = filteredData.filter(record => {
                if (!record.resultDate || isNaN(record.resultDate.getTime())) return false;
                const recordDate = new Date(record.resultDate);
                recordDate.setHours(0, 0, 0, 0);
                const inDateRange = recordDate >= startDateOnly && recordDate <= endDateOnly;
                const noOlderVisits = !patientsWithOlderVisits.has(record.patientId);
                const ageValid = record.age > 34;
                return inDateRange && noOlderVisits && ageValid;
            });
            
            if (weeklyData.length === 0) {
                tableElement.innerHTML = 
                    '<p style="color: rgba(255, 255, 255, 0.7);">No screenings found for the selected date range.</p>';
                return;
            }
            
            // Remove duplicates: if a patient has multiple tests in the week, keep HbA1c over Fasting
            const testPriority = { 'HBA1C': 1, 'FASTING': 2, 'OTHER': 3 };
            weeklyData.sort((a, b) => {
                if (a.patientId !== b.patientId) return a.patientId.localeCompare(b.patientId);
                const priorityA = testPriority[a.resultType] || 3;
                const priorityB = testPriority[b.resultType] || 3;
                return priorityA - priorityB;
            });
            
            // Keep only first record per patient
            const seenPatients = new Set();
            weeklyData = weeklyData.filter(record => {
                if (seenPatients.has(record.patientId)) return false;
                seenPatients.add(record.patientId);
                return true;
            });
            
            // Group by zone
            const zoneData = {};
            weeklyData.forEach(record => {
                const org = record.organization || '';
                const zone = globalZoneLookup[org.toLowerCase().trim().replace(/\s+/g, ' ')] || 'Unknown';
                if (!zoneData[zone]) {
                    zoneData[zone] = [];
                }
                zoneData[zone].push(record);
            });
            
            // Build summary table
            const summaryRows = [];
            // Weekly targets = Daily targets × 5 (Sun, Mon, Tue, Wed, Thu+Fri+Sat)
            const DAILY_TARGETS_LOCAL = {
                "KKH": 225,
                "MCH": 80,
                "BGH": 75,
                "TGH": 75,
                "HGH": 100,
                "KGH": 150,
                "SGH": 200,
                "WNH": 325,
                "NNGH": 200,
                "YGH": 75
            };
            const WEEKLY_TARGETS = {};
            for (const [zone, dailyTarget] of Object.entries(DAILY_TARGETS_LOCAL)) {
                WEEKLY_TARGETS[zone] = dailyTarget * 5;
            }
            const sortedZones = Object.keys(WEEKLY_TARGETS).sort();
            
            sortedZones.forEach(zone => {
                const count = zoneData[zone] ? zoneData[zone].length : 0;
                const target = WEEKLY_TARGETS[zone] || 0;
                const achievement = target > 0 ? (count / target) : 0;
                
                summaryRows.push({
                    zone: zone,
                    target: target,
                    count: count,
                    achievement: achievement
                });
            });
            
            // Add total row
            const totalCount = weeklyData.length;
            const totalTarget = Object.values(WEEKLY_TARGETS).reduce((sum, t) => sum + t, 0);
            const totalAchievement = totalTarget > 0 ? (totalCount / totalTarget) : 0;
            
            const totalRow = {
                zone: 'Total',
                target: totalTarget,
                count: totalCount,
                achievement: totalAchievement
            };
            
            // Sort by achievement (highest to lowest), but keep Total row separate
            summaryRows.sort((a, b) => b.achievement - a.achievement);
            
            // Add Total row at the end
            summaryRows.push(totalRow);
            
            // Function to get color based on achievement percentage
            function getAchievementColor(achievementPct) {
                if (achievementPct >= 100) {
                    return '#00BFFF'; // Bright blue
                } else if (achievementPct >= 80) {
                    return '#00FF00'; // Green
                } else if (achievementPct >= 61) {
                    return '#FFFF00'; // Yellow
                } else if (achievementPct >= 30) {
                    return '#FF0000'; // Red
                } else {
                    return '#000000'; // Black
                }
            }
            
            // Render table
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(70, 130, 180, 0.6);">
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Zone</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Weekly Target</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Screened Count</th>
                            <th style="padding: 15px; text-align: center; color: rgba(255, 255, 255, 0.95); font-size: 1.1em; border-bottom: 2px solid rgba(255, 255, 255, 0.3);">Weekly Achievement %</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            summaryRows.forEach(row => {
                const isTotal = row.zone === 'Total';
                const rowStyle = isTotal ? 'background: rgba(70, 130, 180, 0.3); font-weight: bold;' : '';
                const achievementPct = parseFloat((row.achievement * 100).toFixed(1));
                const achievementColor = getAchievementColor(achievementPct);
                const textColor = achievementPct < 30 ? '#FFFFFF' : '#000000'; // White text for black background
                tableHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.zone}</td>
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.target.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: center; color: rgba(255, 255, 255, 0.9); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${row.count.toLocaleString()}</td>
                        <td style="padding: 12px; text-align: center; background-color: ${achievementColor}; color: ${textColor}; font-weight: bold; border-bottom: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px;">${achievementPct.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('weeklySummaryTable').innerHTML = tableHTML;
        }
        
        function setupDashboardSwipe() {
            const cardsContainer = document.querySelector('.main-cards-container');
            const cards = document.querySelectorAll('.main-cards-container .stat-card');
            const dots = document.querySelectorAll('.dashboard-dot');
            const pagination = document.querySelector('.dashboard-pagination');
            const zoneListContainer = document.getElementById('zoneListContainer');
            
            if (!cardsContainer || cards.length === 0) return;
            
            let interactionTimeout;
            
            function showPagination() {
                if (pagination) {
                    pagination.classList.add('visible');
                }
                clearTimeout(interactionTimeout);
                interactionTimeout = setTimeout(() => {
                    hidePagination();
                }, 2000); // Hide after 2 seconds of no interaction
            }
            
            function hidePagination() {
                if (pagination) {
                    pagination.classList.remove('visible');
                }
            }
            
            function updateActiveDot() {
                const scrollLeft = cardsContainer.scrollLeft;
                const cardWidth = cards[0]?.offsetWidth || 0;
                const gap = 12;
                const scrollPosition = scrollLeft + (cardWidth / 2);
                const currentIndex = Math.round(scrollPosition / (cardWidth + gap));
                const clampedIndex = Math.max(0, Math.min(currentIndex, cards.length - 1));
                
                dots.forEach((dot, index) => {
                    if (index === clampedIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
            
            // Make dots clickable to jump to card
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    const cardWidth = cards[0]?.offsetWidth || 0;
                    const gap = 12;
                    const scrollTo = index * (cardWidth + gap);
                    cardsContainer.scrollTo({
                        left: scrollTo,
                        behavior: 'smooth'
                    });
                    showPagination();
                });
            });
            
            // Show pagination on card interaction
            cardsContainer.addEventListener('scroll', () => {
                showPagination();
                updateActiveDot();
            });
            
            cardsContainer.addEventListener('touchstart', showPagination);
            cardsContainer.addEventListener('mousedown', showPagination);
            
            // Hide pagination when scrolling zone list
            if (zoneListContainer) {
                zoneListContainer.addEventListener('scroll', hidePagination);
                zoneListContainer.addEventListener('touchstart', hidePagination);
                zoneListContainer.addEventListener('mousedown', hidePagination);
            }
            
            // Update on resize
            window.addEventListener('resize', updateActiveDot);
            
            // Initial update
            updateActiveDot();
            
            // Show pagination initially, then hide after 3 seconds
            showPagination();
            setTimeout(() => {
                hidePagination();
            }, 3000);
        }
        
        // Attach click handler for Total DM raw download button (event delegation)
        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target && target.id === 'downloadTotalDmRaw') {
                e.preventDefault();
                e.stopPropagation();
                downloadTotalDmRawData();
            }
        });
        
        // Setup sidebar + mobile tab navigation
        function setupSidebarNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-link, .mobile-tab-link');
            const contentSections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    const section = this.getAttribute('data-section');
                    
                    // Hide all content sections
                    contentSections.forEach(sec => {
                        sec.style.display = 'none';
                    });
                    
                    // Remove dashboard-active class from body
                    document.body.classList.remove('dashboard-active');
                    
                    // Show selected section
                    let targetSection = null;
                    if (section === 'dashboard') {
                        targetSection = document.getElementById('dashboard-section');
                        // Add dashboard-active class to body to prevent scrolling
                        document.body.classList.add('dashboard-active');
                    } else if (section === 'dm-patients') {
                        targetSection = document.getElementById('dm-patients-section');
                    } else if (section === 'pre-dm-patients') {
                        targetSection = document.getElementById('pre-dm-patients-section');
                    } else if (section === 'screening-target') {
                        targetSection = document.getElementById('screening-target-section');
                    }
                    
                    // Building visualization removed
                    
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        // Scroll to top of main content
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        
                        // If showing daily KPI section, ensure button is set up
                        if (section === 'dm-patients') {
                            setupDailySummary();
                        }
                    }
                });
            });
            
            // Set dashboard as default active
            if (navLinks.length > 0) {
                navLinks[0].classList.add('active');
                // Add dashboard-active class if dashboard is the default section
                const firstSection = navLinks[0].getAttribute('data-section');
                if (firstSection === 'dashboard') {
                    document.body.classList.add('dashboard-active');
                }
            }
        }
        
        function setupStatSubCardHandlers() {
            const statSubCards = document.querySelectorAll('.stat-sub-card');
            const subSubCards = document.querySelectorAll('.sub-sub-card');
            let currentlyFlippedCard = null;
            let currentlyFlippedSubCard = null;
            
            // Click handler for each sub-card
            statSubCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't handle clicks on sub-sub-cards
                    if (e.target.closest('.sub-sub-card')) {
                        return;
                    }
                    // Don't handle clicks on no-flip cards
                    if (this.classList.contains('no-flip-card')) {
                        return;
                    }
                    e.stopPropagation();
                    
                    // If this card is already flipped, flip it back
                    if (this.classList.contains('flipped')) {
                        this.classList.remove('flipped');
                        currentlyFlippedCard = null;
                    } else {
                        // If another card is flipped, flip it back first
                        if (currentlyFlippedCard && currentlyFlippedCard !== this) {
                            currentlyFlippedCard.classList.remove('flipped');
                        }
                        
                        // Flip this card
                        this.classList.add('flipped');
                        currentlyFlippedCard = this;
                    }
                });
            });
            
            // Click handler for each sub-sub-card
            subSubCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // If this card is already flipped, flip it back
                    if (this.classList.contains('flipped')) {
                        this.classList.remove('flipped');
                        currentlyFlippedSubCard = null;
                    } else {
                        // If another sub-sub-card is flipped, flip it back first
                        if (currentlyFlippedSubCard && currentlyFlippedSubCard !== this) {
                            currentlyFlippedSubCard.classList.remove('flipped');
                        }
                        
                        // Flip this card
                        this.classList.add('flipped');
                        currentlyFlippedSubCard = this;
                    }
                });
            });
            
            // Unflip when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.stat-sub-card') && !e.target.closest('.sub-sub-card')) {
                    if (currentlyFlippedCard) {
                        currentlyFlippedCard.classList.remove('flipped');
                        currentlyFlippedCard = null;
                    }
                    if (currentlyFlippedSubCard) {
                        currentlyFlippedSubCard.classList.remove('flipped');
                        currentlyFlippedSubCard = null;
                    }
                }
            });
        }

        // Download Total DM raw data as CSV
        function downloadTotalDmRawData() {
            if (!globalDmPatientsRaw || globalDmPatientsRaw.length === 0) {
                alert('Total DM raw data is not available yet. Please ensure the data has finished loading.');
                return;
            }
            
            const header = [
                'Patient_ID',
                'Zone',
                'Organization',
                'Age',
                'First_DM_Date',
                'Latest_Result_Type',
                'Latest_Result_Value',
                'Is_Controlled'
            ];
            
            const rows = globalDmPatientsRaw.map(rec => {
                const firstDate = rec.firstDMDate && !isNaN(new Date(rec.firstDMDate).getTime())
                    ? new Date(rec.firstDMDate).toISOString().split('T')[0]
                    : '';
                return [
                    `"${rec.patientId || ''}"`,
                    `"${rec.zone || ''}"`,
                    `"${(rec.organization || '').replace(/"/g, '""')}"`,
                    rec.age != null ? rec.age : '',
                    `"${firstDate}"`,
                    `"${rec.resultType || ''}"`,
                    rec.resultValue != null ? rec.resultValue : '',
                    rec.isControlled === null || rec.isControlled === undefined ? '' : (rec.isControlled ? 'Controlled' : 'Uncontrolled')
                ].join(',');
            });
            
            const csvContent = [header.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `total_dm_raw_${timestamp}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Expand/collapse zone rows to show organization-level goal alignment
        function setupZoneGoalExpansion(zoneOrgCounts, zonePredmOrgCounts, zoneOrgScreened, totalTargetsByZone) {
            const table = document.getElementById('zone-goal-table');
            if (!table) return;
            
            const summaryRows = table.querySelectorAll('.zone-summary-row');
            const clusterRows = table.querySelectorAll('.cluster-summary-row');
            
            // Cluster-level: toggle visibility of all zones in the cluster
            clusterRows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => {
                    const cluster = row.getAttribute('data-cluster');
                    const zoneRows = table.querySelectorAll(`.zone-summary-row[data-cluster="${cluster}"]`);
                    const detailRows = table.querySelectorAll(`.zone-detail-row[data-cluster="${cluster}"]`);
                    
                    // Determine if we are expanding or collapsing (check first zone row)
                    const shouldShow = Array.from(zoneRows).some(r => r.style.display === 'none' || r.style.display === '');
                    
                    // Collapse all clusters' zone and detail rows first
                    table.querySelectorAll('.zone-summary-row').forEach(r => { r.style.display = 'none'; });
                    table.querySelectorAll('.zone-detail-row').forEach(r => { r.style.display = 'none'; });
                    
                    // If expanding this cluster, show its zones
                    if (shouldShow) {
                        zoneRows.forEach(r => { r.style.display = 'table-row'; });
                        // detail rows remain hidden until zone click
                        detailRows.forEach(r => { r.style.display = 'none'; });
                    }
                });
            });
            
            // Zone-level: toggle org-level details for that zone
            summaryRows.forEach(row => {
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => {
                    const zone = row.getAttribute('data-zone');
                    const detailRow = table.querySelector(`.zone-detail-row[data-zone-detail="${zone}"]`);
                    const container = detailRow ? detailRow.querySelector('.zone-org-container') : null;
                    if (!detailRow || !container) return;
                    
                    const isHidden = detailRow.style.display === 'none' || detailRow.style.display === '';
                    
                    // Collapse any other open detail rows
                    table.querySelectorAll('.zone-detail-row').forEach(r => {
                        if (r !== detailRow) r.style.display = 'none';
                    });
                    
                    if (!isHidden) {
                        detailRow.style.display = 'none';
                        return;
                    }
                    
                    // Build organization-level table for this zone
                    const orgDm = (zoneOrgCounts && zoneOrgCounts[zone]) || {};
                    const orgPredm = (zonePredmOrgCounts && zonePredmOrgCounts[zone]) || {};
                    const orgScreened = (zoneOrgScreened && zoneOrgScreened[zone]) || {};
                    
                    const orgNames = new Set([
                        ...Object.keys(orgDm),
                        ...Object.keys(orgPredm),
                        ...Object.keys(orgScreened)
                    ]);
                    
                    const orgRows = Array.from(orgNames).sort().map(org => {
                        const dmCounts = orgDm[org] || { controlled: 0, uncontrolled: 0 };
                        const dmTotal = (dmCounts.controlled || 0) + (dmCounts.uncontrolled || 0);
                        const dmControlledPct = dmTotal > 0 ? (dmCounts.controlled / dmTotal) * 100 : 0;
                        const dmProgress = 90 > 0 ? Math.min(100, (dmControlledPct / 90) * 100) : 0;
                        
                        const predmCounts = orgPredm[org] || { improved: 0, needFollowup: 0 };
                        const predmTotal = (predmCounts.improved || 0) + (predmCounts.needFollowup || 0);
                        const predmImprovedPct = predmTotal > 0 ? (predmCounts.improved / predmTotal) * 100 : 0;
                        const predmProgress = 50 > 0 ? Math.min(100, (predmImprovedPct / 50) * 100) : 0;
                        
                        const screenedSet = orgScreened[org];
                        const screenedCount = screenedSet ? screenedSet.size : 0;
                        const orgTarget = getOrgTarget(org);
                        const screeningPct = orgTarget > 0 ? (screenedCount / orgTarget) * 100 : 0;
                        const screeningProgress = 70 > 0 ? Math.min(100, (screeningPct / 70) * 100) : 0;
                        
                        // Overall progress for this organization vs all three goals combined
                        // Overall Process % = (DM process % + Pre-DM process % + Screening process %) / 3
                        const orgOverallPct = (dmProgress + predmProgress + screeningProgress) / 3;
                        
                        return `
                            <tr>
                                <td style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.9); border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 0.8em;">
                                    ${org}
                                </td>
                                <td style="padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                    <div style="display: flex; flex-direction: column; gap: 3px;">
                                        <span style="color: rgba(255,255,255,0.9); font-size: 0.75em; font-weight: 600;">
                                            ${orgOverallPct.toFixed(1)}% of combined goals
                                        </span>
                                        <div style="background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; height: 6px;">
                                            <div style="width: ${orgOverallPct.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(0,200,255,0.9), rgba(0,230,118,0.9));"></div>
                                        </div>
                                </td>
                                <td style="padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="color: rgba(255,255,255,0.8); font-size: 0.75em; min-width: 42px;">${dmCounts.controlled} / ${dmTotal} pts</span>
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                            <div style="background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; height: 6px;">
                                                <div style="width: ${dmProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(70,130,180,0.8), rgba(0,200,255,0.9));"></div>
                                            </div>
                                            <span style="color: rgba(255,255,255,0.7); font-size: 0.65em;">
                                                ${dmProgress.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="color: rgba(255,255,255,0.8); font-size: 0.75em; min-width: 42px;">${predmCounts.improved} / ${predmTotal} pts</span>
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                            <div style="background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; height: 6px;">
                                                <div style="width: ${predmProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(76,175,80,0.8), rgba(0,230,118,0.9));"></div>
                                            </div>
                                            <span style="color: rgba(255,255,255,0.7); font-size: 0.65em;">
                                                ${predmProgress.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td style="padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <span style="color: rgba(255,255,255,0.8); font-size: 0.75em; min-width: 42px;">${screenedCount} / ${orgTarget || 0} screened</span>
                                        <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                            <div style="background: rgba(255,255,255,0.08); border-radius: 999px; overflow: hidden; height: 6px;">
                                                <div style="width: ${screeningProgress.toFixed(1)}%; height: 100%; background: linear-gradient(90deg, rgba(255,193,7,0.9), rgba(255,235,59,0.9));"></div>
                                            </div>
                                            <span style="color: rgba(255,255,255,0.7); font-size: 0.65em;">
                                                ${screeningProgress.toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    container.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 4px;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.06);">
                                    <th style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Organization (PHC)</th>
                                    <th style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Overall Progress</th>
                                    <th style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">DM Controlled</th>
                                    <th style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Pre-DM Improved</th>
                                    <th style="padding: 6px 8px; text-align: left; color: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(255,255,255,0.15);">Screening</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${orgRows || '<tr><td colspan="5" style="padding: 8px; text-align: center; color: rgba(255,255,255,0.7);">No organization data for this zone.</td></tr>'}
                            </tbody>
                        </table>
                    `;
                    
                    detailRow.style.display = 'table-row';
                });
            });
        }


        // Simple helper to show how each process indicator is calculated
        function showProcessInfo(message) {
            alert(message);
        }
        
        // Render stacked cards view for Goals section on mobile only
        function renderGoalsMobileCards(zoneMetrics, zoneOrgCounts, zonePredmOrgCounts, zoneOrgScreened, clusterMetrics) {
            const container = document.getElementById('goals-mobile-cards');
            if (!container) return;
            
            let html = '';
            
            // Cluster-level card (NHC – All Zones)
            if (clusterMetrics) {
                const overall = clusterMetrics.overall || 0;
                const dm = clusterMetrics.dm || 0;
                const predm = clusterMetrics.predm || 0;
                const screen = clusterMetrics.screen || 0;
                const screenedCount = clusterMetrics.screenedCount || 0;
                const totalTarget = clusterMetrics.totalTarget || 0;
                const targetForGoal = totalTarget * 0.7; // 70% of total target
                const controlledCount = clusterMetrics.controlledCount || 0;
                const dmPatientCount = clusterMetrics.dmPatientCount || 0;
                const improvedCount = clusterMetrics.improvedCount || 0;
                const predmPatientCount = clusterMetrics.predmPatientCount || 0;
                const dmTargetForGoal = dmPatientCount * 0.9; // 90% of DM patients
                const predmTargetForGoal = predmPatientCount * 0.5; // 50% of Pre-DM patients
                const dmRemaining = Math.max(0, Math.round(dmTargetForGoal - controlledCount));
                const predmRemaining = Math.max(0, Math.round(predmTargetForGoal - improvedCount));
                
                html += `
                    <div class="goal-mobile-card">
                        <div class="goal-mobile-card-header">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div class="goal-mobile-title">NHC – All Zones</div>
                                <span class="goal-info-icon" data-goal-type="all">(i)</span>
                            </div>
                            <div class="goal-mobile-chip">${overall.toFixed(1)}% overall</div>
                        </div>
                        <div class="goal-mobile-overall-label">
                            <span>Cluster Overall</span>
                            <span>${overall.toFixed(1)}%</span>
                        </div>
                        <div class="goal-mobile-overall-track">
                            <div class="goal-mobile-overall-fill" style="width:${Math.min(100, overall).toFixed(1)}%;"></div>
                        </div>
                        <div class="goal-mobile-metrics-row">
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, screen).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${screen.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">Screened</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">Screened</div>
                                            <div class="goal-mobile-circle-back-value">${screenedCount.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${Math.max(0, Math.round(targetForGoal - screenedCount)).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, dm).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${dm.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">DM&nbsp;Controlled</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">DM Controlled</div>
                                            <div class="goal-mobile-circle-back-value">${controlledCount.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${dmRemaining.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, predm).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${predm.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">Pre‑DM&nbsp;Improved</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">Pre-DM Improved</div>
                                            <div class="goal-mobile-circle-back-value">${improvedCount.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${predmRemaining.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Zone + PHC cards (horizontal swipe row)
            html += `<div class="goals-mobile-zones-row">`;
            
            zoneMetrics.forEach(m => {
                const {
                    zone,
                    dmZoneControlledProgress,
                    predmZoneProgress,
                    zoneScreenedProgress,
                    zoneOverallPct,
                    zoneScreenedCount,
                    zoneTarget,
                    dmZoneControlled,
                    dmZoneTotal,
                    predmZoneImproved,
                    predmZoneTotal
                } = m;
                
                const zoneTargetForGoal = zoneTarget * 0.7; // 70% of zone target
                const zoneRemaining = Math.max(0, Math.round(zoneTargetForGoal - zoneScreenedCount));
                const dmZoneTargetForGoal = dmZoneTotal * 0.9; // 90% of zone DM patients
                const predmZoneTargetForGoal = predmZoneTotal * 0.5; // 50% of zone Pre-DM patients
                const dmZoneRemaining = Math.max(0, Math.round(dmZoneTargetForGoal - dmZoneControlled));
                const predmZoneRemaining = Math.max(0, Math.round(predmZoneTargetForGoal - predmZoneImproved));
                
                html += `
                    <div class="goal-mobile-card goal-mobile-zone-card">
                        <div class="goal-mobile-card-header">
                            <div class="goal-mobile-title">${zone}</div>
                            <div class="goal-mobile-chip">${zoneOverallPct.toFixed(1)}% overall</div>
                        </div>
                        <div class="goal-mobile-metrics-row">
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, zoneScreenedProgress).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${zoneScreenedProgress.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">Screened</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">Screened</div>
                                            <div class="goal-mobile-circle-back-value">${zoneScreenedCount.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${zoneRemaining.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, dmZoneControlledProgress).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${dmZoneControlledProgress.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">DM&nbsp;Controlled</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">DM Controlled</div>
                                            <div class="goal-mobile-circle-back-value">${dmZoneControlled.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${dmZoneRemaining.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                <div class="goal-mobile-circle-flip-inner">
                                    <div class="goal-mobile-circle-flip-front">
                                        <div class="goal-mobile-circle" style="--pct:${Math.min(100, predmZoneProgress).toFixed(1)}%;">
                                            <div class="goal-mobile-circle-inner">${predmZoneProgress.toFixed(0)}%</div>
                                        </div>
                                        <div class="goal-mobile-circle-label">Pre‑DM&nbsp;Improved</div>
                                    </div>
                                    <div class="goal-mobile-circle-flip-back">
                                        <div class="goal-mobile-circle-back-content">
                                            <div class="goal-mobile-circle-back-label">Pre-DM Improved</div>
                                            <div class="goal-mobile-circle-back-value">${predmZoneImproved.toLocaleString()}</div>
                                            <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                            <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${predmZoneRemaining.toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="goal-mobile-show-phcs" data-zone="${zone}">
                            Show PHCs ▾
                        </div>
                `;
                
                // PHC-level cards
                const orgDm = (zoneOrgCounts && zoneOrgCounts[zone]) || {};
                const orgPredm = (zonePredmOrgCounts && zonePredmOrgCounts[zone]) || {};
                const orgScreened = (zoneOrgScreened && zoneOrgScreened[zone]) || {};
                const orgNames = new Set([
                    ...Object.keys(orgDm),
                    ...Object.keys(orgPredm),
                    ...Object.keys(orgScreened)
                ]);
                html += `<div class="goal-mobile-phc-cards" data-zone-phcs="${zone}">`;
                
                Array.from(orgNames).sort().forEach(org => {
                    const dmCounts = orgDm[org] || { controlled: 0, uncontrolled: 0 };
                    const dmTotal = (dmCounts.controlled || 0) + (dmCounts.uncontrolled || 0);
                    const dmControlledPct = dmTotal > 0 ? (dmCounts.controlled / dmTotal) * 100 : 0;
                    const dmProgress = 90 > 0 ? Math.min(100, (dmControlledPct / 90) * 100) : 0;
                    
                    const predmCounts = orgPredm[org] || { improved: 0, needFollowup: 0 };
                    const predmTotal = (predmCounts.improved || 0) + (predmCounts.needFollowup || 0);
                    const predmImprovedPct = predmTotal > 0 ? (predmCounts.improved / predmTotal) * 100 : 0;
                    const predmProgress = 50 > 0 ? Math.min(100, (predmImprovedPct / 50) * 100) : 0;
                    
                    const screenedSet = orgScreened[org];
                    const screenedCount = screenedSet ? screenedSet.size : 0;
                    const orgTarget = getOrgTarget(org);
                    const screeningPct = orgTarget > 0 ? (screenedCount / orgTarget) * 100 : 0;
                    const screeningProgress = 70 > 0 ? Math.min(100, (screeningPct / 70) * 100) : 0;
                    const overallPhc = (dmProgress + predmProgress + screeningProgress) / 3;
                    const orgTargetForGoal = orgTarget * 0.7; // 70% of org target
                    const orgRemaining = Math.max(0, Math.round(orgTargetForGoal - screenedCount));
                    const dmOrgTargetForGoal = dmTotal * 0.9; // 90% of org DM patients
                    const predmOrgTargetForGoal = predmTotal * 0.5; // 50% of org Pre-DM patients
                    const dmOrgRemaining = Math.max(0, Math.round(dmOrgTargetForGoal - dmCounts.controlled));
                    const predmOrgRemaining = Math.max(0, Math.round(predmOrgTargetForGoal - predmCounts.improved));
                    
                    html += `
                        <div class="goal-mobile-phc-card">
                            <div class="goal-mobile-phc-header-row">
                                <span>${org}</span>
                                <span>${overallPhc.toFixed(0)}%</span>
                            </div>
                            <div class="goal-mobile-phc-overall-track">
                                <div class="goal-mobile-phc-overall-fill" style="width:${Math.min(100, overallPhc).toFixed(1)}%;"></div>
                            </div>
                            <div class="goal-mobile-metrics-row">
                                <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                    <div class="goal-mobile-circle-flip-inner">
                                        <div class="goal-mobile-circle-flip-front">
                                            <div class="goal-mobile-circle" style="--pct:${Math.min(100, screeningProgress).toFixed(1)}%;">
                                                <div class="goal-mobile-circle-inner">${screeningProgress.toFixed(0)}%</div>
                                            </div>
                                            <div class="goal-mobile-circle-label">Screened</div>
                                        </div>
                                        <div class="goal-mobile-circle-flip-back">
                                            <div class="goal-mobile-circle-back-content">
                                                <div class="goal-mobile-circle-back-label">Screened</div>
                                                <div class="goal-mobile-circle-back-value">${screenedCount.toLocaleString()}</div>
                                                <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                                <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${orgRemaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                    <div class="goal-mobile-circle-flip-inner">
                                        <div class="goal-mobile-circle-flip-front">
                                            <div class="goal-mobile-circle" style="--pct:${Math.min(100, dmProgress).toFixed(1)}%;">
                                                <div class="goal-mobile-circle-inner">${dmProgress.toFixed(0)}%</div>
                                            </div>
                                            <div class="goal-mobile-circle-label">DM&nbsp;Controlled</div>
                                        </div>
                                        <div class="goal-mobile-circle-flip-back">
                                            <div class="goal-mobile-circle-back-content">
                                                <div class="goal-mobile-circle-back-label">DM Controlled</div>
                                                <div class="goal-mobile-circle-back-value">${dmCounts.controlled.toLocaleString()}</div>
                                                <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                                <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${dmOrgRemaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="goal-mobile-circle-metric goal-mobile-circle-flip">
                                    <div class="goal-mobile-circle-flip-inner">
                                        <div class="goal-mobile-circle-flip-front">
                                            <div class="goal-mobile-circle" style="--pct:${Math.min(100, predmProgress).toFixed(1)}%;">
                                                <div class="goal-mobile-circle-inner">${predmProgress.toFixed(0)}%</div>
                                            </div>
                                            <div class="goal-mobile-circle-label">Pre‑DM&nbsp;Improved</div>
                                        </div>
                                        <div class="goal-mobile-circle-flip-back">
                                            <div class="goal-mobile-circle-back-content">
                                                <div class="goal-mobile-circle-back-label">Pre-DM Improved</div>
                                                <div class="goal-mobile-circle-back-value">${predmCounts.improved.toLocaleString()}</div>
                                                <div class="goal-mobile-circle-back-label" style="margin-top: 4px;">Remaining</div>
                                                <div class="goal-mobile-circle-back-value" style="font-size: 0.875rem;">${predmOrgRemaining.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });
            
            html += `</div>`; // close zones row
            
            // Add pagination dots
            if (zoneMetrics.length > 0) {
                html += `<div class="goals-mobile-pagination">`;
                zoneMetrics.forEach((m, index) => {
                    const overallPct = m.zoneOverallPct || 0;
                    let progressClass = 'progress-poor';
                    if (overallPct >= 70) {
                        progressClass = 'progress-excellent';
                    } else if (overallPct >= 40) {
                        progressClass = 'progress-good';
                    }
                    html += `<div class="goals-mobile-dot ${index === 0 ? 'active' : ''} ${progressClass}" data-zone-index="${index}" data-progress="${overallPct.toFixed(1)}"></div>`;
                });
                html += `</div>`;
            }
            
            container.innerHTML = html;
            
            // Setup PHC toggle handlers
            setupPHCToggleHandlers();
            
            // Setup pagination dots scroll handler
            setupZonePaginationDots(zoneMetrics.length);
            
            // Setup flip handler for Screened circle
            setupScreenedCircleFlip();
            
            // Setup goal info icons handler
            setupGoalInfoIcons();
        }
        
        function setupGoalInfoIcons() {
            const infoIcons = document.querySelectorAll('.goal-info-icon');
            if (infoIcons.length === 0) return;
            
            infoIcons.forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const goalType = icon.getAttribute('data-goal-type');
                    let message = '';
                    
                    if (goalType === 'all') {
                        message = 'Strategic Performance Goals\n\n' +
                                  '1. Screening Coverage: Achieve 70% of total target population screened\n\n' +
                                  '2. DM Control: Maintain 90% of diagnosed DM patients with controlled blood glucose levels\n\n' +
                                  '3. Pre-DM Improvement: Achieve 50% improvement rate (return to normal) among Pre-DM patients';
                    }
                    
                    if (message) {
                        alert(message);
                    }
                });
            });
        }
        
        function setupScreenedCircleFlip() {
            const flipContainers = document.querySelectorAll('.goal-mobile-circle-flip');
            if (flipContainers.length === 0) return;
            
            flipContainers.forEach(flipContainer => {
                flipContainer.addEventListener('click', (e) => {
                    // Don't flip if clicking on info icon
                    if (e.target.classList.contains('goal-info-icon')) {
                        return;
                    }
                    e.stopPropagation();
                    flipContainer.classList.toggle('flipped');
                });
            });
        }
        
        function closeAllPHCs() {
            const allPhcContainers = document.querySelectorAll('.goal-mobile-phc-cards');
            const allToggleButtons = document.querySelectorAll('.goal-mobile-show-phcs');
            allPhcContainers.forEach(container => {
                container.classList.remove('expanded');
            });
            allToggleButtons.forEach(toggleBtn => {
                toggleBtn.textContent = 'Show PHCs ▾';
            });
        }
        
        function flipBackAllCharts() {
            const allFlipContainers = document.querySelectorAll('.goal-mobile-circle-flip');
            allFlipContainers.forEach(flipContainer => {
                flipContainer.classList.remove('flipped');
            });
        }
        
        function setupZonePaginationDots(totalZones) {
            if (totalZones === 0) return;
            
            const zonesRow = document.querySelector('.goals-mobile-zones-row');
            const dots = document.querySelectorAll('.goals-mobile-dot');
            const zoneCards = zonesRow?.querySelectorAll('.goal-mobile-zone-card');
            
            if (!zonesRow || dots.length === 0 || !zoneCards) return;
            
            let previousZoneIndex = 0;
            
            function updateActiveDot() {
                const scrollLeft = zonesRow.scrollLeft;
                const cardWidth = zoneCards[0]?.offsetWidth || 0;
                const gap = 12; // gap between cards
                const scrollPosition = scrollLeft + (cardWidth / 2);
                const currentIndex = Math.round(scrollPosition / (cardWidth + gap));
                const clampedIndex = Math.max(0, Math.min(currentIndex, totalZones - 1));
                
                // If zone changed, flip back all charts
                if (clampedIndex !== previousZoneIndex) {
                    flipBackAllCharts();
                    previousZoneIndex = clampedIndex;
                }
                
                dots.forEach((dot, index) => {
                    if (index === clampedIndex) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
            
            // Make dots clickable to jump to zone
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    const cardWidth = zoneCards[0]?.offsetWidth || 0;
                    const gap = 12;
                    const scrollTo = index * (cardWidth + gap);
                    zonesRow.scrollTo({
                        left: scrollTo,
                        behavior: 'smooth'
                    });
                    // Flip back all charts when clicking a dot
                    flipBackAllCharts();
                });
            });
            
            // Update on scroll
            let scrollTimeout;
            zonesRow.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveDot, 50);
            });
            
            // Update on resize
            window.addEventListener('resize', updateActiveDot);
            
            // Initial update
            updateActiveDot();
        }
        
        function setupPHCToggleHandlers() {
            const toggleButtons = document.querySelectorAll('.goal-mobile-show-phcs');
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const zone = btn.getAttribute('data-zone');
                    const phcContainer = document.querySelector(`.goal-mobile-phc-cards[data-zone-phcs="${zone}"]`);
                    if (!phcContainer) return;
                    
                    const isExpanded = phcContainer.classList.contains('expanded');
                    
                    // Close all other PHC containers and reset their button texts
                    closeAllPHCs();
                    
                    // Toggle the clicked zone's PHC container
                    if (isExpanded) {
                        phcContainer.classList.remove('expanded');
                        btn.textContent = 'Show PHCs ▾';
                    } else {
                        phcContainer.classList.add('expanded');
                        btn.textContent = 'Hide PHCs ▴';
                    }
                });
            });
            
            // Close PHCs when swiping to another zone
            const zonesRow = document.querySelector('.goals-mobile-zones-row');
            if (zonesRow) {
                let scrollTimeout;
                zonesRow.addEventListener('scroll', () => {
                    // Clear previous timeout
                    clearTimeout(scrollTimeout);
                    // Close all PHCs after scroll ends (debounce)
                    scrollTimeout = setTimeout(() => {
                        closeAllPHCs();
                    }, 100);
                });
            }
        }
        
        function setupGoalsMobileToggle(zoneMetrics, zoneOrgCounts, zonePredmOrgCounts, zoneOrgScreened, clusterMetrics) {
            // For now we don't expose the metric toggle; just render the full stacked cards once.
            renderGoalsMobileCards(zoneMetrics, zoneOrgCounts, zonePredmOrgCounts, zoneOrgScreened, clusterMetrics);
        }


        // Building Visualization Functions
        function getAgeGroup(age) {
            if (!age || age < 0) return 'Unknown';
            if (age < 35) return '< 35';
            if (age < 51) return '35-50';
            if (age < 66) return '51-65';
            return '> 65';
        }

        function aggregateBuildingData(level = 'cluster', filterZone = null, filterPHC = null) {
            // Get unique patients (patientId -> latest record) and track all visit dates
            const uniquePatients = {}; // For patient demographics (use latest record)
            
            if (!globalAllPatientData || globalAllPatientData.length === 0) {
                return null;
            }

            // First pass: Group by patientId and keep latest record for demographics
            globalAllPatientData.forEach(record => {
                const pid = record.patientId;
                if (!pid) return;
                
                if (!uniquePatients[pid] || 
                    (!uniquePatients[pid].resultDate || (record.resultDate && record.resultDate > uniquePatients[pid].resultDate))) {
                    uniquePatients[pid] = record;
                }
            });

            const aggregation = {};

            // Process each unique patient for demographics
            Object.values(uniquePatients).forEach(patient => {
                const org = patient.organization || '';
                const normalizedOrg = normalizeOrgName(org);
                // Get zone from ORG_TARGETS (global), fallback to 'Unknown'
                const orgTarget = ORG_TARGETS[normalizedOrg];
                const zone = orgTarget ? orgTarget.zone : 'Unknown';
                const cluster = 'NHC'; // All zones are in NHC cluster
                
                let key = '';
                if (level === 'cluster') {
                    key = cluster;
                } else if (level === 'zone') {
                    if (filterZone && zone !== filterZone) return;
                    key = `${cluster}::${zone}`;
                } else if (level === 'phc') {
                    if (filterZone && zone !== filterZone) return;
                    if (filterPHC && normalizedOrg !== normalizeOrgName(filterPHC)) return;
                    key = `${cluster}::${zone}::${normalizedOrg}`;
                }

                if (!key) return;

                if (!aggregation[key]) {
                    aggregation[key] = {
                        cluster,
                        zone: level === 'cluster' ? null : zone,
                        phc: level === 'phc' ? org : null,
                        gender: { Male: 0, Female: 0, Other: 0, Unknown: 0 },
                        ageGroups: { '< 35': 0, '35-50': 0, '51-65': 0, '> 65': 0, 'Unknown': 0 },
                        totalPatients: 0,
                        visitDates: [] // Track all visit dates for this group
                    };
                }

                const agg = aggregation[key];
                agg.totalPatients++;

                // Count gender
                const gender = (patient.gender || '').trim();
                if (!gender || gender === '') {
                    agg.gender.Unknown++;
                } else {
                    const genderLower = gender.toLowerCase();
                    if (genderLower.includes('male') || genderLower === 'm') {
                        agg.gender.Male++;
                    } else if (genderLower.includes('female') || genderLower === 'f') {
                        agg.gender.Female++;
                    } else {
                        agg.gender.Other++;
                    }
                }

                // Count age group
                const ageGroup = getAgeGroup(patient.age);
                agg.ageGroups[ageGroup] = (agg.ageGroups[ageGroup] || 0) + 1;
            });

            // Second pass: Collect all visit dates for each group (from all records, not just unique patients)
            globalAllPatientData.forEach(record => {
                if (!record.patientId) return;
                
                const org = record.organization || '';
                const normalizedOrg = normalizeOrgName(org);
                const orgTarget = ORG_TARGETS[normalizedOrg];
                const zone = orgTarget ? orgTarget.zone : 'Unknown';
                const cluster = 'NHC';
                
                let key = '';
                if (level === 'cluster') {
                    key = cluster;
                } else if (level === 'zone') {
                    if (filterZone && zone !== filterZone) return;
                    key = `${cluster}::${zone}`;
                } else if (level === 'phc') {
                    if (filterZone && zone !== filterZone) return;
                    if (filterPHC && normalizedOrg !== normalizeOrgName(filterPHC)) return;
                    key = `${cluster}::${zone}::${normalizedOrg}`;
                }

                if (!key || !aggregation[key]) return;

                // Track visit dates for this group
                if (record.resultDate && record.resultDate instanceof Date && !isNaN(record.resultDate.getTime())) {
                    aggregation[key].visitDates.push(record.resultDate);
                }
            });

            // Calculate date ranges for each aggregation group
            Object.keys(aggregation).forEach(key => {
                const agg = aggregation[key];
                if (agg.visitDates.length > 0) {
                    agg.oldestDate = new Date(Math.min(...agg.visitDates.map(d => d.getTime())));
                    agg.newestDate = new Date(Math.max(...agg.visitDates.map(d => d.getTime())));
                }
                // Clean up visitDates array to save memory
                delete agg.visitDates;
            });

            return aggregation;
        }

        function renderBuildingVisualization(level = 'cluster', filterZone = null, filterPHC = null) {
            const container = document.getElementById('buildingVisualizationContent');
            if (!container) {
                console.error('Building visualization container not found');
                return;
            }

            // Check if data is available
            if (!globalAllPatientData || globalAllPatientData.length === 0) {
                container.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">No patient data available yet. Please wait for data to load.</p>';
                return;
            }

            let data;
            try {
                data = aggregateBuildingData(level, filterZone, filterPHC);
                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<p style="color: rgba(255, 255, 255, 0.7);">No data available for the selected level.</p>';
                    return;
                }
            } catch (error) {
                console.error('Error rendering building visualization:', error);
                container.innerHTML = '<p style="color: rgba(255, 100, 100, 0.9);">Error loading visualization. Please check console for details.</p>';
                return;
            }

            const breadcrumb = document.getElementById('buildingBreadcrumb');
            let breadcrumbHTML = '<span class="breadcrumb-item" data-level="cluster" style="cursor: pointer; color: rgba(70, 130, 180, 0.9); text-decoration: underline;">NHC - All Clusters</span>';
            
            if (level === 'zone' || level === 'phc') {
                breadcrumbHTML += ' <span style="margin: 0 8px;">→</span> <span class="breadcrumb-item" data-level="zone" data-zone="' + filterZone + '" style="cursor: pointer; color: rgba(70, 130, 180, 0.9); text-decoration: underline;">' + filterZone + '</span>';
            }
            if (level === 'phc') {
                breadcrumbHTML += ' <span style="margin: 0 8px;">→</span> <span style="color: rgba(255, 255, 255, 0.8);">' + filterPHC + '</span>';
            }
            breadcrumb.innerHTML = breadcrumbHTML;

            let html = '<div class="building-viz-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">';
            
            const sortedKeys = Object.keys(data).sort((a, b) => {
                if (level === 'cluster') return 0;
                if (level === 'zone') {
                    const zoneA = data[a].zone || '';
                    const zoneB = data[b].zone || '';
                    return zoneA.localeCompare(zoneB);
                }
                if (level === 'phc') {
                    const phcA = data[a].phc || '';
                    const phcB = data[b].phc || '';
                    return phcA.localeCompare(phcB);
                }
                return 0;
            });

            sortedKeys.forEach(key => {
                const item = data[key];
                const title = level === 'cluster' ? 'NHC - All Clusters' : 
                             level === 'zone' ? item.zone : 
                             item.phc;

                html += `
                    <div class="building-viz-card" style="border-radius: 16px; padding: 16px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.7) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2); color: white; overflow: hidden; position: relative; cursor: ${level !== 'phc' ? 'pointer' : 'default'}; transition: all 0.2s ease;" 
                         ${level !== 'phc' ? `data-level="${level}" data-key="${key}" data-zone="${item.zone || ''}" data-phc="${item.phc || ''}"` : ''}
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.4)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2)'">
                        <div class="goal-mobile-card-header" style="margin-bottom: 12px;">
                            <div class="goal-mobile-title" style="font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.98);">${title}</div>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 12px;">
                            <div style="font-size: 1.5em; font-weight: 700; color: rgba(255, 255, 255, 0.98); word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">${item.totalPatients.toLocaleString()}</div>
                            <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.7); margin-top: 4px;">Total Patients</div>
                        </div>

                        ${item.oldestDate && item.newestDate ? `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.8); margin-bottom: 6px;">Visit Date Range</div>
                            <div style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.7); line-height: 1.4;">
                                <div>Oldest: <strong>${item.oldestDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</strong></div>
                                <div>Newest: <strong>${item.newestDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</strong></div>
                            </div>
                        </div>
                        ` : ''}

                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.8); margin-bottom: 10px; text-align: center;">Gender</div>
                            <div style="position: relative; height: 150px; margin-bottom: 10px;">
                                <canvas id="genderChart_${key.replace(/[^a-zA-Z0-9]/g, '_')}" style="max-height: 150px;"></canvas>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.7rem;">
                                ${(() => {
                                    const totalGender = item.gender.Male + item.gender.Female + item.gender.Other + item.gender.Unknown;
                                    const genderItems = [];
                                    if (item.gender.Male > 0) {
                                        const pct = totalGender > 0 ? ((item.gender.Male / totalGender) * 100).toFixed(1) : 0;
                                        genderItems.push(`<div style="text-align: center;"><span style="color: #3b82f6;">●</span> Male: <strong>${item.gender.Male} (${pct}%)</strong></div>`);
                                    }
                                    if (item.gender.Female > 0) {
                                        const pct = totalGender > 0 ? ((item.gender.Female / totalGender) * 100).toFixed(1) : 0;
                                        genderItems.push(`<div style="text-align: center;"><span style="color: #ec4899;">●</span> Female: <strong>${item.gender.Female} (${pct}%)</strong></div>`);
                                    }
                                    if (item.gender.Other > 0) {
                                        const pct = totalGender > 0 ? ((item.gender.Other / totalGender) * 100).toFixed(1) : 0;
                                        genderItems.push(`<div style="text-align: center;"><span style="color: #fbbf24;">●</span> Other: <strong>${item.gender.Other} (${pct}%)</strong></div>`);
                                    }
                                    if (item.gender.Unknown > 0) {
                                        const pct = totalGender > 0 ? ((item.gender.Unknown / totalGender) * 100).toFixed(1) : 0;
                                        genderItems.push(`<div style="text-align: center;"><span style="color: #94a3b8;">●</span> Unknown: <strong>${item.gender.Unknown} (${pct}%)</strong></div>`);
                                    }
                                    return genderItems.join('');
                                })()}
                            </div>
                        </div>

                        <div>
                            <div style="font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.8); margin-bottom: 10px;">Age Groups</div>
                            ${(() => {
                                const totalAge = item.ageGroups['< 35'] + item.ageGroups['35-50'] + item.ageGroups['51-65'] + item.ageGroups['> 65'] + (item.ageGroups.Unknown || 0);
                                const ageItems = [
                                    { label: '< 35', count: item.ageGroups['< 35'], color: 'rgba(76, 175, 80, 0.6)' },
                                    { label: '35-50', count: item.ageGroups['35-50'], color: 'rgba(33, 150, 243, 0.6)' },
                                    { label: '51-65', count: item.ageGroups['51-65'], color: 'rgba(255, 152, 0, 0.6)' },
                                    { label: '> 65', count: item.ageGroups['> 65'], color: 'rgba(244, 67, 54, 0.6)' },
                                    ...(item.ageGroups.Unknown > 0 ? [{ label: 'Unknown', count: item.ageGroups.Unknown, color: 'rgba(150, 150, 150, 0.6)' }] : [])
                                ];
                                return ageItems.map(a => {
                                    const pct = totalAge > 0 ? ((a.count / totalAge) * 100).toFixed(1) : 0;
                                    return `
                                        <div style="margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                                <span style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.9);">${a.label}</span>
                                                <span style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.9); font-weight: 600;">${a.count} (${pct}%)</span>
                                            </div>
                                            <div style="width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                                <div style="width: ${pct}%; height: 100%; background: ${a.color}; border-radius: 4px; transition: width 0.3s ease;"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            container.innerHTML = html;

            // Create donut charts for gender visualization
            sortedKeys.forEach(key => {
                const item = data[key];
                const chartId = `genderChart_${key.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const chartCanvas = document.getElementById(chartId);
                if (!chartCanvas) return;

                const totalGender = item.gender.Male + item.gender.Female + item.gender.Other + item.gender.Unknown;
                if (totalGender === 0) return;

                const genderData = [];
                const genderLabels = [];
                const genderColors = [];

                if (item.gender.Male > 0) {
                    genderData.push(item.gender.Male);
                    genderLabels.push('Male');
                    genderColors.push('rgba(59, 130, 246, 0.85)'); // Professional blue
                }
                if (item.gender.Female > 0) {
                    genderData.push(item.gender.Female);
                    genderLabels.push('Female');
                    genderColors.push('rgba(236, 72, 153, 0.85)'); // Professional pink
                }
                if (item.gender.Other > 0) {
                    genderData.push(item.gender.Other);
                    genderLabels.push('Other');
                    genderColors.push('rgba(251, 191, 36, 0.85)'); // Professional amber
                }
                if (item.gender.Unknown > 0) {
                    genderData.push(item.gender.Unknown);
                    genderLabels.push('Unknown');
                    genderColors.push('rgba(148, 163, 184, 0.85)'); // Professional slate gray
                }

                new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: genderLabels,
                        datasets: [{
                            data: genderData,
                            backgroundColor: genderColors,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'rgba(255, 255, 255, 0.9)',
                                bodyColor: 'rgba(255, 255, 255, 0.9)',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                            }
                        }
                    }
                });
            });

            // Add click handlers for drill-down
            if (level !== 'phc') {
                container.querySelectorAll('.building-viz-card[data-level]').forEach(card => {
                    card.addEventListener('click', function() {
                        const cardLevel = this.getAttribute('data-level');
                        const zone = this.getAttribute('data-zone');
                        const phc = this.getAttribute('data-phc');
                        
                        if (cardLevel === 'cluster') {
                            renderBuildingVisualization('zone', null, null);
                        } else if (cardLevel === 'zone') {
                            renderBuildingVisualization('phc', zone, null);
                        } else if (cardLevel === 'phc' && phc) {
                            renderBuildingVisualization('phc', zone, phc);
                        }
                    });
                });
            }

            // Add breadcrumb click handlers
            breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.addEventListener('click', function() {
                    const itemLevel = this.getAttribute('data-level');
                    const itemZone = this.getAttribute('data-zone');
                    
                    if (itemLevel === 'cluster') {
                        renderBuildingVisualization('cluster');
                    } else if (itemLevel === 'zone') {
                        renderBuildingVisualization('zone', itemZone, null);
                    }
                });
            });
        }

        // Start typing animation on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startTypingAnimation);
        } else {
            startTypingAnimation();
        }

        // Initial load
        loadData();

    </script>
</body>
</html>
